<app-notification></app-notification>
<div class="container">
  <h2>Objective Management</h2>

  <div *ngIf="loading" class="alert alert-info">
    Loading, please wait...
  </div>

  <div class="button-container">
    <button class="btn btn-primary" (click)="openAddModal()" [disabled]="loading">
      Add Objective
    </button>
    <button class="btn btn-primary" (click)="navigateToWorkflow()" title="Back to Workflow Page">
      <i class="las la-arrow-left me-2"></i>Back to Workflow
    </button>
    <button id="chatbot-toggler" (click)="toggleChatbotModal()" [ngClass]="{'show-chatbot': isChatbotOpen}">
      <span class="las la-comment-alt"></span>
      <span class="las la-times"></span>
    </button>
  </div>

  <div *ngIf="objectives.length === 0 && !loading" class="alert alert-info">
    No objectives found.
  </div>

  <table *ngIf="objectives.length > 0 && !loading" class="table table-bordered">
    <thead>
    <tr>
      <th>Title</th>
      <th>Axe</th>
      <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <tr *ngFor="let objective of objectives">
      <td>{{ objective.title }}</td>
      <td>{{ objective.axe | titlecase }}</td>
      <td>
        <button class="btn btn-danger btn-sm" (click)="deleteObjective(objective.idObjective!, objective.title)" [disabled]="loading">
          <i class="fas fa-trash-alt"></i>
        </button>
      </td>
    </tr>
    </tbody>
  </table>

  <!-- Objective Modal -->
  <ng-template #objectiveModal let-modal>
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Objective</h5>
        <button type="button" class="custom-close" (click)="modal.dismiss('Cross click')">
          <span>×</span>
        </button>
      </div>
      <div class="modal-body">
        <form [formGroup]="objectiveForm" (ngSubmit)="addObjective()">
          <div class="mb-3">
            <label for="title" class="form-label">Title</label>
            <input
              type="text"
              id="title"
              formControlName="title"
              class="form-control"
              [ngClass]="{'is-invalid': submitted && objectiveForm.controls['title'].errors}"
            />
            <div *ngIf="submitted && objectiveForm.controls['title'].errors" class="invalid-feedback">
              <div *ngIf="objectiveForm.controls['title'].errors['required']">Title is required</div>
              <div *ngIf="objectiveForm.controls['title'].errors['minlength']">Title must be at least 3 characters</div>
            </div>
          </div>
          <div class="mb-3">
            <label for="axe" class="form-label">Axe</label>
            <select
              id="axe"
              formControlName="axe"
              class="form-select"
              [ngClass]="{'is-invalid': submitted && objectiveForm.controls['axe'].errors}"
            >
              <option value="" disabled>Select an axe</option>
              <option *ngFor="let axe of axeOptions" [value]="axe">{{ axe | titlecase }}</option>
            </select>
            <div *ngIf="submitted && objectiveForm.controls['axe'].errors" class="invalid-feedback">
              <div *ngIf="objectiveForm.controls['axe'].errors['required']">Axe is required</div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" (click)="modal.dismiss('Cancel click')">Cancel</button>
            <button type="submit" class="btn btn-primary" [disabled]="loading">
              {{ loading ? 'Adding...' : 'Add Objective' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </ng-template>

  <!-- Chatbot Modal -->
  <ng-template #chatbotModal let-modal>
    <div class="chatbot-popup">
      <div class="chat-header">
        <div class="header-info">
          <img src="assets/images/logo-icon.png" alt="Chatbot Logo" class="chatbot-logo" />
          <span class="logo-text">Objective Assistant</span>
        </div>
        <button id="close-chatbot" (click)="toggleChatbotModal()">
          <span>×</span>
        </button>
      </div>
      <div class="chat-body" #chatBody>
        <div *ngFor="let message of conversation" class="message" [ngClass]="{'user-message': message.sender === 'user', 'bot-message': message.sender === 'ai'}">
          <div *ngIf="message.sender === 'ai' && !message.error && !message.freeformResponse" class="thinking-indicator">
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
          </div>
          <img *ngIf="message.sender === 'ai'" src="assets/images/logo-icon.png" alt="Bot Avatar" class="bot-avatar" />
          <div class="message-text" [ngClass]="{'error': message.error}">
            {{ message.text || message.freeformResponse || message.error }}
          </div>
        </div>
      </div>
      <div class="chat-footer">
        <form class="chat-form" (ngSubmit)="sendQuery()">
          <textarea
            class="message-input"
            placeholder="Type your query..."
            [(ngModel)]="query"
            [ngModelOptions]="{standalone: true}"
            (keydown.enter)="sendQuery(); $event.preventDefault()"
          ></textarea>
          <div class="chat-controls">
            <button type="button" id="clear-message" (click)="clear()" [disabled]="loading || !query">
              <i class="las la-trash-alt"></i>
            </button>
            <button type="submit" id="send-message" [disabled]="loading || !query">
              <i class="las la-paper-plane"></i>
            </button>
          </div>
        </form>
      </div>
    </div>
  </ng-template>

  <!-- Axes Overview Section -->
  <div class="mt-5">
    <h3>Axes Overview</h3>
    <div class="row justify-content-center">
      @for (item of axesData; track $index) {
        <div class="col-md-6 col-lg-4">
          <div class="card">
            <div class="card-body">
              <div [ngClass]="{ 'text-center': $index >= 3 }">
                <img [src]="item.image" [alt]="item.title + ' image'" class="img-fluid rounded" />
                <div class="mt-3">
                  <span class="badge bg-purple-subtle text-purple px-2 py-1 fw-semibold">{{ item.category }}</span>
                  |
                  <p class="mb-0 text-muted fs-12 d-inline-block">{{ item.date }}</p>
                </div>
                <a href="javascript:void(0);" [ngClass]="{ 'my-3': $index >= 3 }" class="d-block fs-18 fw-medium text-body my-2 text-truncate">
                  {{ item.title }}
                </a>
                <p class="text-muted">{{ item.content }}</p>
                <hr class="hr-dashed" />
                <div class="d-flex justify-content-end">
                  <div class="align-self-center">
                    <a href="javascript:void(0);" class="btn btn-sm btn-primary">
                      Read more <i class="fas fa-long-arrow-alt-right"></i>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      }
    </div>
  </div>
</div>
