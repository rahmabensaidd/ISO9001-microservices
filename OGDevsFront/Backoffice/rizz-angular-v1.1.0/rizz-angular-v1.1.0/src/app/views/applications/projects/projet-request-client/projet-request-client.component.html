<div class="container mb-5">
  <div class="card shadow-sm border-0">
    <div class="card-body p-4">
      <!-- Header -->
      <h2 class="section-header d-flex align-items-center mb-4 border-bottom pb-2">
        <i class="las la-project-diagram me-2 fs-5 text-primary"></i>
        <span class="fs-5 text-dark">My Project Requests</span>
        <a class="btn btn-primary ms-auto" (click)="openAddProjetRequestModal(addProjetRequestModal)">
          <i class="fa-solid fa-plus me-1"></i> Nouvelle Demande
        </a>
      </h2>

      <!-- Loading State -->
      @if (!projetRequests) {
        <div class="text-center text-muted mb-4">
          <i class="las la-spinner la-spin me-2"></i>Loading, please wait...
        </div>
      }

      <!-- No Project Requests Message -->
      @if (projetRequests && projetRequests.length === 0) {
        <div class="alert alert-info">
          No project requests found.
        </div>
      }

      <!-- Project Requests Table -->
      @if (projetRequests && projetRequests.length > 0) {
        <div class="table-responsive">
          <table class="table datatable table-striped">
            <thead class="table-light">
            <tr>
              <th>Email</th>
              <th>Budget (€)</th>
              <th>Start Date</th>
              <th>End Date</th>
              <th>Description</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
            </thead>
            <tbody>
              @for (projetRequest of displayedProjetRequests; track projetRequest.id) {
                <tr class="align-middle">
                  <td>{{ projetRequest.email }}</td>
                  <td>{{ projetRequest.budgetProposedByClient | number:'1.2-2' }}</td>
                  <td>{{ projetRequest.desiredStartDate | date }}</td>
                  <td>{{ projetRequest.desiredEndDate | date }}</td>
                  <td>{{ projetRequest.description }}</td>
                  <td>
                    <span [ngClass]="{
                      'badge bg-warning': projetRequest.statut === StatutRequestProjet.EN_ATTENTE,
                      'badge bg-success': projetRequest.statut === StatutRequestProjet.ACCEPTEE,
                      'badge bg-danger': projetRequest.statut === StatutRequestProjet.REFUSEE
                    }">
                      {{ projetRequest.statut }}
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-primary btn-sm me-1"
                            (click)="openModifyProjetRequestModal(modifyProjetRequestModal, projetRequest)">
                      <i class="las la-pen"></i> Modifier
                    </button>
                    <button class="btn btn-danger btn-sm"
                            (click)="deleteProjetRequest(projetRequest.id!)">
                      <i class="las la-trash-alt"></i> Supprimer
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>

          <div class="d-flex justify-content-between p-2">
            <ngb-pagination
              [collectionSize]="projetRequestsCollectionSize"
              [(page)]="projetRequestsPage"
              [pageSize]="projetRequestsPageSize"
              (pageChange)="refreshProjetRequests()"
              [boundaryLinks]="false"
              [maxSize]="0"
            >
              <ng-template ngbPaginationPrevious>
                <span>« </span>
              </ng-template>
              <ng-template ngbPaginationNext>
                <span> »</span>
              </ng-template>
            </ngb-pagination>

            <select
              class="form-select"
              style="width: auto"
              [(ngModel)]="projetRequestsPageSize"
              (ngModelChange)="refreshProjetRequests()"
            >
              <option [ngValue]="2">2 items per page</option>
              <option [ngValue]="4">4 items per page</option>
              <option [ngValue]="6">6 items per page</option>
            </select>
          </div>
        </div>
      }
    </div>
  </div>
</div>

<!-- Modale pour ajouter une demande de projet -->
<ng-template #addProjetRequestModal let-modal>
  <div class="modal-header">
    <h6 class="modal-title m-0">Nouvelle Demande de Projet</h6>
    <button type="button" class="btn-close" (click)="modal.dismiss()" aria-label="Close"></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="projetRequestForm" (ngSubmit)="createProjetRequest()">
      <div class="mb-3 row">
        <label for="email" class="col-sm-3 col-form-label text-end fw-medium">Email :</label>
        <div class="col-sm-9">
          <input type="email" formControlName="email" class="form-control" id="email" readonly
                 [ngClass]="{ 'is-invalid': submitted && form['email']?.errors }" />
          @if (submitted && form['email']?.errors) {
            <div class="invalid-feedback">
              L'email est requis et doit être valide
            </div>
          }
        </div>
      </div>
      <div class="mb-3 row">
        <label for="budget" class="col-sm-3 col-form-label text-end fw-medium">Budget (€) :</label>
        <div class="col-sm-9">
          <input type="number" formControlName="budgetProposedByClient" class="form-control" id="budget"
                 [ngClass]="{ 'is-invalid': submitted && form['budgetProposedByClient']?.errors }" />
          @if (submitted && form['budgetProposedByClient']?.errors) {
            <div class="invalid-feedback">
              Le budget est requis et doit être positif
            </div>
          }
        </div>
      </div>
      <div class="mb-3 row">
        <label for="startDate" class="col-sm-3 col-form-label text-end fw-medium">Date de Début :</label>
        <div class="col-sm-9">
          <input type="date" formControlName="desiredStartDate" class="form-control" id="startDate"
                 [ngClass]="{ 'is-invalid': submitted && form['desiredStartDate']?.errors }" />
          @if (submitted && form['desiredStartDate']?.errors) {
            <div class="invalid-feedback">
              La date de début est requise
            </div>
          }
        </div>
      </div>
      <div class="mb-3 row">
        <label for="endDate" class="col-sm-3 col-form-label text-end fw-medium">Date de Fin :</label>
        <div class="col-sm-9">
          <input type="date" formControlName="desiredEndDate" class="form-control" id="endDate"
                 [ngClass]="{ 'is-invalid': submitted && form['desiredEndDate']?.errors }" />
          @if (submitted && form['desiredEndDate']?.errors) {
            <div class="invalid-feedback">
              La date de fin est requise
            </div>
          }
        </div>
      </div>
      <div class="mb-3 row">
        <label for="description" class="col-sm-3 col-form-label text-end fw-medium">Description :</label>
        <div class="col-sm-9">
          <textarea formControlName="description" class="form-control" id="description" rows="4"
                    [ngClass]="{ 'is-invalid': submitted && form['description']?.errors }"></textarea>
          @if (submitted && form['description']?.errors) {
            <div class="invalid-feedback">
              La description est requise
            </div>
          }
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary btn-sm" (click)="createProjetRequest()">Enregistrer</button>
    <button type="button" class="btn btn-outline-danger btn-sm" (click)="modal.dismiss()">Fermer</button>
  </div>
</ng-template>

<!-- Modale pour modifier une demande de projet -->
<ng-template #modifyProjetRequestModal let-modal>
  <div class="modal-header">
    <h6 class="modal-title m-0">Modifier une Demande de Projet</h6>
    <button type="button" class="btn-close" (click)="modal.dismiss()" aria-label="Close"></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="modifyForm" (ngSubmit)="modifyProjetRequest()">
      <div class="mb-3 row">
        <label for="modifyEmail" class="col-sm-3 col-form-label text-end fw-medium">Email :</label>
        <div class="col-sm-9">
          <input type="email" formControlName="email" class="form-control" id="modifyEmail" readonly
                 [ngClass]="{ 'is-invalid': submitted && modifyFormControls['email']?.errors }" />
          @if (submitted && modifyFormControls['email']?.errors) {
            <div class="invalid-feedback">
              L'email est requis et doit être valide
            </div>
          }
        </div>
      </div>
      <div class="mb-3 row">
        <label for="modifyBudget" class="col-sm-3 col-form-label text-end fw-medium">Budget (€) :</label>
        <div class="col-sm-9">
          <input type="number" formControlName="budgetProposedByClient" class="form-control" id="modifyBudget"
                 [ngClass]="{ 'is-invalid': submitted && modifyFormControls['budgetProposedByClient']?.errors }" />
          @if (submitted && modifyFormControls['budgetProposedByClient']?.errors) {
            <div class="invalid-feedback">
              Le budget est requis et doit être positif
            </div>
          }
        </div>
      </div>
      <div class="mb-3 row">
        <label for="modifyStartDate" class="col-sm-3 col-form-label text-end fw-medium">Date de Début :</label>
        <div class="col-sm-9">
          <input type="date" formControlName="desiredStartDate" class="form-control" id="modifyStartDate"
                 [ngClass]="{ 'is-invalid': submitted && modifyFormControls['desiredStartDate']?.errors }" />
          @if (submitted && modifyFormControls['desiredStartDate']?.errors) {
            <div class="invalid-feedback">
              La date de début est requise
            </div>
          }
        </div>
      </div>
      <div class="mb-3 row">
        <label for="modifyEndDate" class="col-sm-3 col-form-label text-end fw-medium">Date de Fin :</label>
        <div class="col-sm-9">
          <input type="date" formControlName="desiredEndDate" class="form-control" id="modifyEndDate"
                 [ngClass]="{ 'is-invalid': submitted && modifyFormControls['desiredEndDate']?.errors }" />
          @if (submitted && modifyFormControls['desiredEndDate']?.errors) {
            <div class="invalid-feedback">
              La date de fin est requise
            </div>
          }
        </div>
      </div>
      <div class="mb-3 row">
        <label for="modifyDescription" class="col-sm-3 col-form-label text-end fw-medium">Description :</label>
        <div class="col-sm-9">
          <textarea formControlName="description" class="form-control" id="modifyDescription" rows="4"
                    [ngClass]="{ 'is-invalid': submitted && modifyFormControls['description']?.errors }"></textarea>
          @if (submitted && modifyFormControls['description']?.errors) {
            <div class="invalid-feedback">
              La description est requise
            </div>
          }
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary btn-sm" (click)="modifyProjetRequest()">Enregistrer</button>
    <button type="button" class="btn btn-outline-danger btn-sm" (click)="modal.dismiss()">Fermer</button>
  </div>
</ng-template>
