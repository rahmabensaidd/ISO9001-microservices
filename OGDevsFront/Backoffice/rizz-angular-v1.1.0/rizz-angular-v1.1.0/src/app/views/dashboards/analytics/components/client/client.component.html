<div class="container mb-5">
  <!-- My Tickets -->
  <div class="card shadow-sm border-0">
    <div class="card-body p-4">
      <!-- Header -->
      <h2 class="section-header d-flex align-items-center mb-4 border-bottom pb-2">
        <i class="las la-ticket-alt me-2 fs-5 text-primary"></i>
        <span class="fs-5 text-dark">My Tickets</span>
        <a class="btn btn-primary ms-auto" (click)="openAddTicketModal(addTicketModal)">
          <i class="fa-solid fa-plus me-1"></i> Ajouter un Ticket
        </a>
      </h2>

      <!-- Loading State -->
      @if (!tickets) {
        <div class="text-center text-muted mb-4">
          <i class="las la-spinner la-spin me-2"></i>Loading, please wait...
        </div>
      }

      <!-- No Tickets Message -->
      @if (tickets && tickets.length === 0) {
        <div class="alert alert-info">
          No tickets found.
        </div>
      }

      <!-- Tickets Table -->
      @if (tickets && tickets.length > 0) {
        <div class="table-responsive">
          <table class="table datatable table-striped">
            <thead class="table-light">
            <tr>
              <th>Titre</th>
              <th>Description</th>
              <th>Statut</th>
              <th>Type</th>
              <th>Date de création</th>
              <th>Actions</th>
            </tr>
            </thead>
            <tbody>
              @for (ticket of displayedTickets; track ticket.id) {
                <tr class="align-middle">
                  <td>{{ ticket.title }}</td>
                  <td>{{ ticket.description }}</td>
                  <td>{{ ticket.status }}</td>
                  <td>{{ ticket.type }}</td>
                  <td>{{ ticket.createdAt | date }}</td>
                  <td>
                    <button class="btn btn-primary btn-sm me-1" (click)="openModifyTicketModal(modifyTicketModal, ticket)">
                      <i class="las la-pen"></i> Modifier
                    </button>
                    <button class="btn btn-danger btn-sm" (click)="deleteTicket(ticket.id!)">
                      <i class="las la-trash-alt"></i> Supprimer
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>

          <div class="d-flex justify-content-between p-2">
            <ngb-pagination
              [collectionSize]="ticketsCollectionSize"
              [(page)]="ticketsPage"
              [pageSize]="ticketsPageSize"
              (pageChange)="refreshTickets()"
              [boundaryLinks]="false"
              [maxSize]="0"
            >
              <ng-template ngbPaginationPrevious>
                <span>« </span>
              </ng-template>
              <ng-template ngbPaginationNext>
                <span> »</span>
              </ng-template>
            </ngb-pagination>

            <select
              class="form-select"
              style="width: auto"
              [(ngModel)]="ticketsPageSize"
              (ngModelChange)="refreshTickets()"
            >
              <option [ngValue]="2">2 items per page</option>
              <option [ngValue]="4">4 items per page</option>
              <option [ngValue]="6">6 items per page</option>
            </select>
          </div>
        </div>
      }
    </div>
  </div>

  <!-- My Meetings -->
  <div class="card shadow-sm border-0 mt-5">
    <div class="card-body p-4">
      <!-- Header -->
      <h2 class="section-header d-flex align-items-center mb-4 border-bottom pb-2">
        <i class="las la-calendar me-2 fs-5 text-primary"></i>
        <span class="fs-5 text-dark">My Meetings</span>
      </h2>

      <!-- Loading State -->
      @if (!userMeetings) {
        <div class="text-center text-muted mb-4">
          <i class="las la-spinner la-spin me-2"></i>Loading, please wait...
        </div>
      }

      <!-- No Meetings Message -->
      @if (userMeetings && userMeetings.length === 0) {
        <div class="alert alert-info">
          No meetings found.
        </div>
      }

      <!-- Meetings Table -->
      @if (userMeetings && userMeetings.length > 0) {
        <div class="table-responsive">
          <table class="table datatable table-striped">
            <thead class="table-light">
            <tr>
              <th>Title</th>
              <th>Date</th>
              <th>Hour</th>
              <th>Status</th>
              <th>Meeting link</th>
            </tr>
            </thead>
            <tbody>
              @for (meeting of displayedMeetings; track meeting.meetingid) {
                <tr class="align-middle">
                  <td>{{ getMeetingTitle(meeting) }}</td>
                  <td>{{ meeting.meetingDate }}</td>
                  <td>{{ meeting.meetingTime }}</td>
                  <td>{{ meeting.meetingStatus }}</td>
                  <td>
                    <a class="btn btn-primary btn-sm" [href]="meeting.meetingLink" target="_blank">
                      <i class="las la-video me-1"></i> Rejoindre
                    </a>
                  </td>
                </tr>
              }
            </tbody>
          </table>

          <div class="d-flex justify-content-between p-2">
            <ngb-pagination
              [collectionSize]="meetingsCollectionSize"
              [(page)]="meetingsPage"
              [pageSize]="meetingsPageSize"
              (pageChange)="refreshMeetings()"
              [boundaryLinks]="false"
              [maxSize]="0"
            >
              <ng-template ngbPaginationPrevious>
                <span>« </span>
              </ng-template>
              <ng-template ngbPaginationNext>
                <span> »</span>
              </ng-template>
            </ngb-pagination>

            <select
              class="form-select"
              style="width: auto"
              [(ngModel)]="meetingsPageSize"
              (ngModelChange)="refreshMeetings()"
            >
              <option [ngValue]="2">2 items per page</option>
              <option [ngValue]="4">4 items per page</option>
              <option [ngValue]="6">6 items per page</option>
            </select>
          </div>
        </div>
      }
    </div>
  </div>
</div>

<!-- Modale pour ajouter un ticket -->
<ng-template #addTicketModal let-modal>
  <div class="modal-header">
    <h6 class="modal-title m-0">Ajouter un Nouveau Ticket</h6>
    <button type="button" class="btn-close" (click)="modal.dismiss()" aria-label="Close"></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="ticketForm" (ngSubmit)="createTicket()">
      <div class="mb-3 row">
        <label for="title" class="col-sm-3 col-form-label text-end fw-medium">Titre :</label>
        <div class="col-sm-9">
          <input
            type="text"
            formControlName="title"
            class="form-control"
            id="title"
            placeholder="Titre du ticket"
            [ngClass]="{ 'is-invalid': submitted && form['title'].errors }"
          />
          @if (submitted && form['title'].errors) {
            <div class="invalid-feedback">Le titre est requis</div>
          }
        </div>
      </div>
      <div class="mb-3 row">
        <label for="description" class="col-sm-3 col-form-label text-end fw-medium">Description :</label>
        <div class="col-sm-9">
          <textarea
            formControlName="description"
            class="form-control"
            id="description"
            placeholder="Description du ticket"
            [ngClass]="{ 'is-invalid': submitted && form['description'].errors }"
          ></textarea>
          @if (submitted && form['description'].errors) {
            <div class="invalid-feedback">La description est requise</div>
          }
        </div>
      </div>
      <div class="mb-3 row">
        <label for="status" class="col-sm-3 col-form-label text-end fw-medium">Statut :</label>
        <div class="col-sm-9">
          <select
            formControlName="status"
            class="form-select"
            id="status"
            [ngClass]="{ 'is-invalid': submitted && form['status'].errors }"
          >
            <option value="">Sélectionner un statut</option>
            @for (status of ticketStatuses; track status) {
              <option [value]="status">{{ status }}</option>
            }
          </select>
          @if (submitted && form['status'].errors) {
            <div class="invalid-feedback">Le statut est requis</div>
          }
        </div>
      </div>
      <div class="mb-3 row">
        <label for="type" class="col-sm-3 col-form-label text-end fw-medium">Type :</label>
        <div class="col-sm-9">
          <select
            formControlName="type"
            class="form-select"
            id="type"
            [ngClass]="{ 'is-invalid': submitted && form['type'].errors }"
          >
            <option value="">Sélectionner un type</option>
            @for (type of ticketTypes; track type) {
              <option [value]="type">{{ type }}</option>
            }
          </select>
          @if (submitted && form['type'].errors) {
            <div class="invalid-feedback">Le type est requis</div>
          }
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary btn-sm" (click)="createTicket()">Enregistrer</button>
    <button type="button" class="btn btn-outline-danger btn-sm" (click)="modal.dismiss()">Fermer</button>
  </div>
</ng-template>

<!-- Modale pour modifier un ticket -->
<ng-template #modifyTicketModal let-modal>
  <div class="modal-header">
    <h6 class="modal-title m-0">Modifier un Ticket</h6>
    <button type="button" class="btn-close" (click)="modal.dismiss()" aria-label="Close"></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="modifyForm" (ngSubmit)="modifyTicket()">
      <div class="mb-3 row">
        <label for="modifyTitle" class="col-sm-3 col-form-label text-end fw-medium">Titre :</label>
        <div class="col-sm-9">
          <input
            type="text"
            formControlName="title"
            class="form-control"
            id="modifyTitle"
            placeholder="Titre du ticket"
            [ngClass]="{ 'is-invalid': submitted && modifyFormControls['title'].errors }"
          />
          @if (submitted && modifyFormControls['title'].errors) {
            <div class="invalid-feedback">Le titre est requis</div>
          }
        </div>
      </div>
      <div class="mb-3 row">
        <label for="modifyDescription" class="col-sm-3 col-form-label text-end fw-medium">Description :</label>
        <div class="col-sm-9">
          <textarea
            formControlName="description"
            class="form-control"
            id="modifyDescription"
            placeholder="Description du ticket"
            [ngClass]="{ 'is-invalid': submitted && modifyFormControls['description'].errors }"
          ></textarea>
          @if (submitted && modifyFormControls['description'].errors) {
            <div class="invalid-feedback">La description est requise</div>
          }
        </div>
      </div>
      <div class="mb-3 row">
        <label for="modifyStatus" class="col-sm-3 col-form-label text-end fw-medium">Statut :</label>
        <div class="col-sm-9">
          <select
            formControlName="status"
            class="form-select"
            id="modifyStatus"
            [ngClass]="{ 'is-invalid': submitted && modifyFormControls['status'].errors }"
          >
            <option value="">Sélectionner un statut</option>
            @for (status of ticketStatuses; track status) {
              <option [value]="status">{{ status }}</option>
            }
          </select>
          @if (submitted && modifyFormControls['status'].errors) {
            <div class="invalid-feedback">Le statut est requis</div>
          }
        </div>
      </div>
      <div class="mb-3 row">
        <label for="modifyType" class="col-sm-3 col-form-label text-end fw-medium">Type :</label>
        <div class="col-sm-9">
          <select
            formControlName="type"
            class="form-select"
            id="modifyType"
            [ngClass]="{ 'is-invalid': submitted && modifyFormControls['type'].errors }"
          >
            <option value="">Sélectionner un type</option>
            @for (type of ticketTypes; track type) {
              <option [value]="type">{{ type }}</option>
            }
          </select>
          @if (submitted && modifyFormControls['type'].errors) {
            <div class="invalid-feedback">Le type est requis</div>
          }
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary btn-sm" (click)="modifyTicket()">Enregistrer</button>
    <button type="button" class="btn btn-outline-danger btn-sm" (click)="modal.dismiss()">Fermer</button>
  </div>
</ng-template>
