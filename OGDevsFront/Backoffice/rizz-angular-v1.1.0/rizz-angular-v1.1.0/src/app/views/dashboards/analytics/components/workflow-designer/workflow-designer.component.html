<div class="container">
  <!-- Top toolbar -->
  <div class="top-toolbar">
    <button class="btn btn-primary" (click)="saveWorkflow()" title="Save the current workflow">Save Workflow</button>


    <!-- Dropdown to load a saved snapshot by workflow ID -->
    <select [(ngModel)]="selectedWorkflowName" class="form-control mx-2" (change)="loadWorkflowByName()" title="Select a workflow to load">
      <option [ngValue]="null">Select Workflow to Load</option>
      <option *ngFor="let workflow of workflowNames" [ngValue]="workflow.name"> {{ workflow.name }} </option>
    </select>
    <button class="btn btn-info mx-2" (click)="toggleDisplayMode()" title="Toggle between interactive graph and saved snapshot">
      {{ showSnapshot ? 'Show Interactive Graph' : 'Show Saved Snapshot' }}
    </button>

    <!-- Delete buttons for link and element -->
    <button type="button" class="btn btn-danger mx-2" (click)="deleteLinkOrElement()" *ngIf="selectedLink" title="Delete the selected link">
      Delete Link
    </button>
    <button type="button" class="btn btn-danger mx-2" (click)="deleteLinkOrElement()" *ngIf="selectedElement && !isAssignMode" title="Delete the selected element">
      Delete Element
    </button>

    <!-- Add Objective Button -->
    <button class="btn btn-primary mx-2" (click)="navigateToObjectives()" title="Navigate to Objectives Page">
      View Objectives
    </button>
    <!-- Chatbot Toggle Button -->
    <button class="btn btn-info mx-2" (click)="toggleChatbot()" title="Toggle chatbot visibility">
      {{ showChatbot ? 'Hide Chatbot' : 'Show Chatbot' }}
    </button>

    <!-- Modify buttons for elements -->
    <a class="btn btn-outline-primary mx-2" (click)="openProcessModal(selectedElementView!)" *ngIf="selectedElement && selectedElement.prop('elementType') === 'process' && !isAssignMode" title="Modify the selected process">
      <i class="fa-solid fa-edit me-1"></i> Modify Process
    </a>
    <a class="btn btn-outline-primary mx-2" (click)="openOperationModal(selectedElementView!)" *ngIf="selectedElement && selectedElement.prop('elementType') === 'operation' && !isAssignMode" title="Modify the selected operation">
      <i class="fa-solid fa-edit me-1"></i> Modify Operation
    </a>
    <a class="btn btn-outline-primary mx-2" (click)="openTaskModal(selectedElementView!)" *ngIf="selectedElement && selectedElement.prop('elementType') === 'task' && !isAssignMode" title="Modify the selected task">
      <i class="fa-solid fa-edit me-1"></i> Modify Task
    </a>
  </div>

  <!-- Main content area -->
  <div class="main-content">
    <!-- Sidebar on the left -->
    <div class="toolbox">
      <h4>Toolbox</h4>
      <div class="element" (dragstart)="onDragStart($event, 'process')" draggable="true" role="button" tabindex="0" (keyup.enter)="addElementToGraph('process', 50, 50)" title="Drag to add a process">Process</div>
      <div class="element" (dragstart)="onDragStart($event, 'operation')" draggable="true" role="button" tabindex="0" (keyup.enter)="addElementToGraph('operation', 50, 50)" title="Drag to add an operation">Operation</div>
      <div class="element" (dragstart)="onDragStart($event, 'task')" draggable="true" role="button" tabindex="0" (keyup.enter)="addElementToGraph('task', 50, 50)" title="Drag to add a task">Task</div>
      <div class="element" (click)="enableAssignMode()" role="button" tabindex="0" (keyup.enter)="enableAssignMode()" title="Enable assign mode to link elements">
        <i class="fas fa-arrow-right"></i> Assign Mode
      </div>

      <!-- Edit Element Section -->
      <div *ngIf="selectedElement && !isAssignMode" class="edit-section">
        <h3>Edit Element</h3>
        <div class="form-group">
          <label for="elementName">Name:</label>
          <input id="elementName" type="text" [(ngModel)]="selectedElementName" (blur)="updateElement()" class="form-control" title="Edit element name" />
        </div>
        <div class="form-group">
          <label for="elementColor">Color:</label>
          <input id="elementColor" type="color" [(ngModel)]="selectedElementColor" (change)="updateElement()" class="form-control" title="Change element color" />
        </div>
        <div class="form-group">
          <label for="elementWidth">Width:</label>
          <input id="elementWidth" type="number" [(ngModel)]="selectedElementWidth" (blur)="updateElement()" class="form-control" min="50" title="Set element width" />
        </div>
        <div class="form-group">
          <label for="elementHeight">Height:</label>
          <input id="elementHeight" type="number" [(ngModel)]="selectedElementHeight" (blur)="updateElement()" class="form-control" min="30" title="Set element height" />
        </div>
        <div class="form-group">
          <label for="elementShape">Shape:</label>
          <select id="elementShape" [(ngModel)]="selectedElementShape" (change)="updateElement()" class="form-control" title="Change element shape">
            <option value="rectangle">Rectangle</option>
            <option value="circle">Circle</option>
          </select>
        </div>
        <div class="form-group">
          <label for="elementFontFamily">Font Family:</label>
          <select id="elementFontFamily" [(ngModel)]="selectedElementFontFamily" (change)="updateElement()" class="form-control" title="Change font family">
            <option value="Arial">Arial</option>
            <option value="Times New Roman">Times New Roman</option>
            <option value="Courier New">Courier New</option>
            <option value="Verdana">Verdana</option>
          </select>
        </div>
        <div class="form-group">
          <label for="elementFontSize">Font Size:</label>
          <input id="elementFontSize" type="number" [(ngModel)]="selectedElementFontSize" (blur)="updateElement()" class="form-control" min="8" max="24" title="Set font size" />
        </div>
      </div>
    </div>

    <!-- Canvas (paper) on the right -->
    <div class="workflow-container">
      <div #paperContainer class="paper-container" (drop)="onDrop($event)" (dragover)="onDragOver($event)" [style.display]="showSnapshot ? 'none' : 'block'"></div>
      <div id="snapshotContainer" class="snapshot-container" [style.display]="showSnapshot ? 'block' : 'none'"></div>
    </div>
  </div>

  <!-- Chatbot Popup -->
  <div class="chatbot-popup" #chatbotPopup *ngIf="showChatbot" [@popupAnimation]>
    <div class="chatbot-header">
      <h3>Co-Consult AI Agent</h3>
      <button class="btn btn-secondary mx-2" (click)="toggleVoiceMode()" [disabled]="isChatbotLoading" title="Toggle voice mode">
        <i class="fas fa-microphone"></i> {{ isVoiceMode ? 'Stop Voice Mode' : 'Start Voice Mode' }}
      </button>
      <button class="btn-close" (click)="toggleChatbot()" aria-label="Close chatbot"></button>
    </div>
    <div class="chat-history">
      <div *ngFor="let message of chatHistory" class="chat-message">
        <div class="question"><strong>You:</strong> {{ message.question }}</div>
        <div class="response"><strong>Chatbot:</strong> {{ message.response }}</div>
      </div>
      <div *ngIf="isChatbotLoading" class="loading">Thinking...</div>
    </div>
    <div class="chat-input" *ngIf="!isVoiceMode">
      <input
        type="text"
        [(ngModel)]="chatbotQuestion"
        (keyup.enter)="sendTextQuestion()"
        placeholder="Ask a question..."
        class="form-control"
        [disabled]="isChatbotLoading"
        aria-label="Chatbot question input"
      />
      <button
        class="btn btn-primary mt-2"
        (click)="sendTextQuestion()"
        [disabled]="isChatbotLoading || !chatbotQuestion.trim()"
        title="Send your question to the chatbot"
      >
        Send
      </button>
    </div>
  </div>

  <!-- Indicators Panel -->
  <div class="indicators-panel" *ngIf="selectedProcess">
    <h3>Indicators for Process: {{ selectedProcess.procName }}</h3>
    <div *ngIf="loadingIndicators" class="loading-spinner">
      Loading indicators...
    </div>
    <div *ngIf="!loadingIndicators && indicators.length === 0" class="no-data">
      No indicators found for this process.
    </div>
    <div *ngIf="!loadingIndicators && indicators.length > 0">
      <!-- Indicators Table -->
      <table class="table table-bordered">
        <thead>
        <tr>
          <th>Code</th>
          <th>Name</th>
          <th>Description</th>
          <th>Type</th>
          <th>Frequency</th>
          <th>Unit</th>
          <th>Target Value</th>
          <th>Actual Value</th>
          <th>Status</th>
          <th>Last Calculated</th>
          <th>Active</th>
          <th>Non-Conformities</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let indicator of indicators" [ngClass]="getStatusClass(indicator)">
          <td>{{ indicator.code }}</td>
          <td>{{ indicator.libelle }}</td>
          <td>{{ indicator.description }}</td>
          <td>{{ indicator.type }}</td>
          <td>{{ indicator.frequence }}</td>
          <td>{{ indicator.unite }}</td>
          <td>{{ indicator.cible }}</td>
          <td>{{ indicator.currentValue || 'N/A' }}</td>
          <td>{{ getStatus(indicator) }}</td>
          <td>{{ indicator.lastCalculated | date:'medium' }}</td>
          <td>{{ indicator.actif ? 'Yes' : 'No' }}</td>
          <td>{{ getNonConformitiesCount(indicator) }} non-conformities</td>
        </tr>
        </tbody>
      </table>
      <button class="btn btn-primary" (click)="refreshIndicators()" [disabled]="loadingIndicators" title="Refresh indicators">
        Refresh Indicators
      </button>
    </div>
  </div>

  <!-- Modal for adding/editing a Process -->
  <ng-template #addProcessTask let-modal>
    <div class="modal-header">
      <h6 class="modal-title m-0">{{ selectedElement && selectedElement.attr('label/text') !== 'Unnamed Process' ? 'Edit Process' : 'Add Process' }}</h6>
      <button type="button" class="btn-close" (click)="modal.dismiss()" aria-label="Close"></button>
    </div>
    <div class="modal-body">
      <form [formGroup]="processForm">
        <div class="mb-3 row">
          <label for="processName" class="col-sm-3 col-form-label text-end fw-medium">Process Name:</label>
          <div class="col-sm-9">
            <input
              type="text"
              formControlName="procName"
              class="form-control"
              id="processName"
              [ngClass]="{ 'is-invalid': submitted && processForm.get('procName')?.errors?.['required'] }"
              aria-required="true"
            />
            <div *ngIf="submitted && processForm.get('procName')?.errors?.['required']" class="invalid-feedback">
              Process name is required.
            </div>
          </div>
        </div>
        <div class="mb-3 row">
          <label for="processCreationDate" class="col-sm-3 col-form-label text-end fw-medium">Creation Date:</label>
          <div class="col-sm-9">
            <input
              type="date"
              formControlName="creationDate"
              class="form-control"
              id="processCreationDate"
              [ngClass]="{ 'is-invalid': submitted && processForm.get('creationDate')?.errors?.['required'] }"
            />
            <div *ngIf="submitted && processForm.get('creationDate')?.errors?.['required']" class="invalid-feedback">
              Creation date is required.
            </div>
          </div>
        </div>
        <div class="mb-3 row">
          <label for="modifDate" class="col-sm-3 col-form-label text-end fw-medium">Modification Date:</label>
          <div class="col-sm-9">
            <input
              type="date"
              formControlName="modifDate"
              class="form-control"
              id="modifDate"
              [ngClass]="{ 'is-invalid': submitted && processForm.get('modifDate')?.errors?.['required'] }"
            />
            <div *ngIf="submitted && processForm.get('modifDate')?.errors?.['required']" class="invalid-feedback">
              Modification date is required.
            </div>
          </div>
        </div>
        <div class="mb-3 row">
          <label for="processFinishDate" class="col-sm-3 col-form-label text-end fw-medium">Finish Date:</label>
          <div class="col-sm-9">
            <input
              type="date"
              formControlName="finishDate"
              class="form-control"
              id="processFinishDate"
            />
          </div>
        </div>
        <div class="mb-3 row">
          <label for="description" class="col-sm-3 col-form-label text-end fw-medium">Description:</label>
          <div class="col-sm-9">
            <textarea
              formControlName="description"
              class="form-control"
              id="description"
              rows="2"
              [ngClass]="{ 'is-invalid': submitted && processForm.get('description')?.errors?.['required'] }"
              aria-required="true"
            ></textarea>
            <div *ngIf="submitted && processForm.get('description')?.errors?.['required']" class="invalid-feedback">
              Description is required.
            </div>
          </div>
        </div>
        <!-- Pilote Dropdown -->
        <div class="mb-3 row">
          <label for="pilote" class="col-sm-3 col-form-label text-end fw-medium">Pilote:</label>
          <div class="col-sm-9">
            <select
              formControlName="pilote"
              class="form-control"
              id="pilote"
              [ngClass]="{ 'is-invalid': submitted && processForm.get('pilote')?.errors?.['required'] }"
              aria-required="true"
            >
              <option [ngValue]="null">Select a Pilote</option>
              <option *ngFor="let user of users" [ngValue]="user">
                {{ user.username }} ({{ user.email }})
              </option>
            </select>
            <div *ngIf="submitted && processForm.get('pilote')?.errors?.['required']" class="invalid-feedback">
              Pilote is required.
            </div>
          </div>
        </div>
        <!-- Objective Selection -->
        <!--  <div class="mb-3 row">
            <label for="objective" class="col-sm-3 col-form-label text-end fw-medium">Objective:</label>
            <div class="col-sm-9">
              <select
                id="objective"
                [(ngModel)]="selectedObjective"
                [ngModelOptions]="{ standalone: true }"
                class="form-control"
                (change)="onObjectiveChange(selectedObjective)"
              >
                <option [ngValue]="null">Select an Objective</option>
                <option *ngFor="let objective of objectives" [ngValue]="objective">
                  {{ objective.title }} (ID: {{ objective.idObjective || 'N/A' }})
                </option>
              </select>
            </div>
          </div> -->
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-primary btn-sm" (click)="saveProcessToDatabase()" title="Save process">Save</button>
      <button type="button" class="btn btn-outline-danger btn-sm" (click)="modal.dismiss()" title="Close modal">Close</button>
    </div>
  </ng-template>

  <!-- Modal for adding/editing an Operation -->
  <ng-template #addOperationModal let-modal>
    <div class="modal-header">
      <h6 class="modal-title m-0">{{ selectedElement && selectedElement.attr('label/text') !== 'Unnamed Operation' ? 'Edit Operation' : 'Add Operation' }}</h6>
      <button type="button" class="btn-close" (click)="modal.dismiss()" aria-label="Close"></button>
    </div>
    <div class="modal-body">
      <form [formGroup]="operationForm">
        <div class="mb-3 row">
          <label for="operationName" class="col-sm-3 col-form-label text-end fw-medium">Operation Name:</label>
          <div class="col-sm-9">
            <input
              type="text"
              formControlName="operationName"
              class="form-control"
              id="operationName"
              [ngClass]="{ 'is-invalid': submitted && operationForm.get('operationName')?.errors?.['required'] }"
              aria-required="true"
            />
            <div *ngIf="submitted && operationForm.get('operationName')?.errors?.['required']" class="invalid-feedback">
              Operation name is required.
            </div>
          </div>
        </div>
        <div class="mb-3 row">
          <label for="operationDescription" class="col-sm-3 col-form-label text-end fw-medium">Description:</label>
          <div class="col-sm-9">
            <textarea
              formControlName="operationDescription"
              class="form-control"
              id="operationDescription"
              rows="2"
              [ngClass]="{ 'is-invalid': submitted && operationForm.get('operationDescription')?.errors?.['required'] }"
              aria-required="true"
            ></textarea>
            <div *ngIf="submitted && operationForm.get('operationDescription')?.errors?.['required']" class="invalid-feedback">
              Description is required.
            </div>
          </div>
        </div>
        <div class="mb-3 row">
          <label for="operationCreationDate" class="col-sm-3 col-form-label text-end fw-medium">Creation Date:</label>
          <div class="col-sm-9">
            <input
              type="date"
              formControlName="creationDate"
              class="form-control"
              id="operationCreationDate"
              [ngClass]="{ 'is-invalid': submitted && operationForm.get('creationDate')?.errors?.['required'] }"
            />
            <div *ngIf="submitted && operationForm.get('creationDate')?.errors?.['required']" class="invalid-feedback">
              Creation date is required.
            </div>
          </div>
        </div>
        <div class="mb-3 row">
          <label for="operationFinishDate" class="col-sm-3 col-form-label text-end fw-medium">Finish Date:</label>
          <div class="col-sm-9">
            <input
              type="date"
              formControlName="finishDate"
              class="form-control"
              id="operationFinishDate"
            />
          </div>
        </div>
        <!-- Postes Dropdown (Multi-select) -->
        <div class="mb-3 row">
          <label for="postes" class="col-sm-3 col-form-label text-end fw-medium">Postes:</label>
          <div class="col-sm-9">
            <select
              formControlName="postes"
              class="form-control"
              id="postes"
              multiple
            >
              <option *ngFor="let poste of postes" [value]="poste.id">
                {{ poste.mission }} (Salaire: {{ poste.salaire }})
              </option>
            </select>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-primary btn-sm" (click)="saveOperationToDatabase()" title="Save operation">Save</button>
      <button type="button" class="btn btn-outline-danger btn-sm" (click)="modal.dismiss()" title="Close modal">Close</button>
    </div>
  </ng-template>

  <!-- Modal for adding/editing a Task -->
  <ng-template #addTaskModal let-modal>
    <div class="modal-header">
      <h6 class="modal-title m-0">{{ selectedElement && selectedElement.attr('label/text') !== 'Unnamed Task' ? 'Edit Task' : 'Add Task' }}</h6>
      <button type="button" class="btn-close" (click)="modal.dismiss()" aria-label="Close"></button>
    </div>
    <div class="modal-body">
      <form [formGroup]="taskForm">
        <div class="mb-3 row">
          <label for="taskDescription" class="col-sm-3 col-form-label text-end fw-medium">Task Description:</label>
          <div class="col-sm-9">
            <textarea
              formControlName="taskDescription"
              class="form-control"
              id="taskDescription"
              rows="2"
              [ngClass]="{ 'is-invalid': submitted && taskForm.get('taskDescription')?.errors?.['required'] }"
              aria-required="true"
            ></textarea>
            <div *ngIf="submitted && taskForm.get('taskDescription')?.errors?.['required']" class="invalid-feedback">
              Task description is required.
            </div>
          </div>
        </div>
        <div class="mb-3 row">
          <label for="taskStatus" class="col-sm-3 col-form-label text-end fw-medium">Status:</label>
          <div class="col-sm-9">
            <select
              formControlName="taskStatus"
              class="form-control"
              id="taskStatus"
              [ngClass]="{ 'is-invalid': submitted && taskForm.get('taskStatus')?.errors?.['required'] }"
              aria-required="true"
            >
              <option value="TODO">To Do</option>
              <option value="IN_PROGRESS">In Progress</option>
              <option value="DONE">Done</option>
            </select>
            <div *ngIf="submitted && taskForm.get('taskStatus')?.errors?.['required']" class="invalid-feedback">
              Task status is required.
            </div>
          </div>
        </div>
        <div class="mb-3 row">
          <label for="taskCreationDate" class="col-sm-3 col-form-label text-end fw-medium">Creation Date:</label>
          <div class="col-sm-9">
            <input
              type="date"
              formControlName="creationDate"
              class="form-control"
              id="taskCreationDate"
              [ngClass]="{ 'is-invalid': submitted && taskForm.get('creationDate')?.errors?.['required'] }"
            />
            <div *ngIf="submitted && taskForm.get('creationDate')?.errors?.['required']" class="invalid-feedback">
              Creation date is required.
            </div>
          </div>
        </div>
        <div class="mb-3 row">
          <label for="taskFinishDate" class="col-sm-3 col-form-label text-end fw-medium">Finish Date:</label>
          <div class="col-sm-9">
            <input
              type="date"
              formControlName="finishDate"
              class="form-control"
              id="taskFinishDate"
            />
          </div>
        </div>
        <!-- Data Selection -->
        <div class="mb-3 row">
          <label for="dataIds" class="col-sm-3 col-form-label text-end fw-medium">Data:</label>
          <div class="col-sm-9">
            <select
              formControlName="dataIds"
              class="form-control"
              id="dataIds"
              multiple
            >
              <option *ngFor="let data of dataList" [value]="data.id">
                {{ data.content }} ({{ data.datatype }} - {{ data.registrationDate | date:'medium' }})
              </option>
            </select>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-primary btn-sm" (click)="addTask()" title="Save task">Save</button>
      <button type="button" class="btn btn-outline-danger btn-sm" (click)="modal.dismiss()" title="Close modal">Close</button>
    </div>
  </ng-template>

  <!-- Modal for adding/editing an Objective -->
  <ng-template #addObjectiveModal let-modal>
    <div class="modal-header">
      <h6 class="modal-title m-0">Add Objective</h6>
      <button type="button" class="btn-close" (click)="modal.dismiss()" aria-label="Close"></button>
    </div>
    <div class="modal-body">
      <form [formGroup]="objectiveForm">
        <div class="mb-3 row">
          <label for="objectiveTitle" class="col-sm-3 col-form-label text-end fw-medium">Title:</label>
          <div class="col-sm-9">
            <input
              type="text"
              formControlName="title"
              class="form-control"
              id="objectiveTitle"
              [ngClass]="{ 'is-invalid': submitted && objectiveForm.get('title')?.errors?.['required'] }"
              aria-required="true"
            />
            <div *ngIf="submitted && objectiveForm.get('title')?.errors?.['required']" class="invalid-feedback">
              Title is required.
            </div>
          </div>
        </div>
        <div class="mb-3 row">
          <label for="objectiveAxe" class="col-sm-3 col-form-label text-end fw-medium">Axe:</label>
          <div class="col-sm-9">
            <select
              formControlName="axe"
              class="form-control"
              id="objectiveAxe"
              [ngClass]="{ 'is-invalid': submitted && objectiveForm.get('axe')?.errors?.['required'] }"
              aria-required="true"
            >
              <option value="">Select an Axe</option>
              <option value="Amélioration_de_la_productivité_03">Amélioration de la productivité 03</option>
              <option value="Respect_des_engagements_05">Respect des engagements 05</option>
            </select>
            <div *ngIf="submitted && objectiveForm.get('axe')?.errors?.['required']" class="invalid-feedback">
              Axe is required.
            </div>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-primary btn-sm" (click)="addObjective()" title="Save objective">Save</button>
      <button type="button" class="btn btn-outline-danger btn-sm" (click)="modal.dismiss()" title="Close modal">Close</button>
    </div>
  </ng-template>

  <!-- Modal for entering workflow name -->
  <ng-template #workflowNameModal let-modal>
    <div class="modal-header">
      <h6 class="modal-title m-0">Enter Workflow Name</h6>
      <button type="button" class="btn-close" (click)="modal.dismiss()" aria-label="Close"></button>
    </div>
    <div class="modal-body">
      <form [formGroup]="workflowNameForm">
        <div class="mb-3">
          <label for="workflowName" class="form-label">Workflow Name:</label>
          <input
            type="text"
            formControlName="workflowName"
            class="form-control"
            id="workflowName"
            [ngClass]="{ 'is-invalid': workflowNameForm.get('workflowName')?.invalid && (workflowNameForm.get('workflowName')?.touched || workflowNameForm.get('workflowName')?.dirty) }"
            aria-required="true"
          />
          <div *ngIf="workflowNameForm.get('workflowName')?.errors?.['required'] && (workflowNameForm.get('workflowName')?.touched || workflowNameForm.get('workflowName')?.dirty)" class="invalid-feedback">
            Workflow name is required.
          </div>
          <div *ngIf="workflowNameForm.get('workflowName')?.errors?.['minlength'] && (workflowNameForm.get('workflowName')?.touched || workflowNameForm.get('workflowName')?.dirty)" class="invalid-feedback">
            Workflow name must be at least 3 characters long.
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-primary btn-sm" (click)="submitWorkflowName()" title="Save workflow name">Save</button>
      <button type="button" class="btn btn-outline-danger btn-sm" (click)="modal.dismiss()" title="Close modal">Close</button>
    </div>
  </ng-template>
</div>
