<div class="container-fluid p-0">
  <div class="row justify-content-center">
    <div class="col-md-12">
      <div class="card shadow-lg border-0">
        <div class="card-header bg-primary text-white">
          <h4 class="card-title mb-0">KPI Dashboard</h4>
        </div>

        <div class="card-body pt-0">
          <!-- Original Charts -->
          <div class="row g-4">
            <div class="col-md-6">
              <div class="card h-100 shadow-sm">
                <div class="card-header bg-light">
                  <h5 class="card-title">Bar Chart (Value vs Target)</h5>
                </div>
                <div class="card-body">
                  <div id="column_chart" class="apex-charts">
                    <apx-chart
                      [chart]="columnChart.chart!"
                      [series]="columnChart.series!"
                      [xaxis]="columnChart.xaxis!"
                      [yaxis]="columnChart.yaxis!"
                      [colors]="columnChart.colors!"
                      [dataLabels]="columnChart.dataLabels!"
                      [plotOptions]="columnChart.plotOptions!"
                      [tooltip]="columnChart.tooltip!"
                    />
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card h-100 shadow-sm">
                <div class="card-header bg-light">
                  <h5 class="card-title">Line Chart (Trends)</h5>
                </div>
                <div class="card-body">
                  <div id="line_chart" class="apex-charts">
                    <apx-chart
                      [chart]="lineChart.chart!"
                      [annotations]="lineChart.annotations!"
                      [colors]="lineChart.colors!"
                      [dataLabels]="lineChart.dataLabels!"
                      [stroke]="lineChart.stroke!"
                      [series]="lineChart.series!"
                      [labels]="lineChart.labels!"
                      [yaxis]="lineChart.yaxis!"
                      [grid]="lineChart.grid!"
                      [legend]="lineChart.legend!"
                      [fill]="lineChart.fill!"
                    />
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6 col-lg-6">
              <div class="card h-100 shadow-sm">
                <div class="card-header bg-light">
                  <h5 class="card-title">Area Chart - Datetime X-Axis</h5>
                </div>
                <div class="card-body pt-0">
                  <div class="toolbar">
                    <button class="btn btn-sm btn-outline-light me-0.5" id="one_month" (click)="updateAreaChartRange('1m')">1M</button>
                    <button class="btn btn-sm btn-outline-light me-0.5" id="six_months" (click)="updateAreaChartRange('6m')">6M</button>
                    <button class="btn btn-sm btn-outline-light active me-0.5" id="one_year" (click)="updateAreaChartRange('1y')">1Y</button>
                    <button class="btn btn-sm btn-outline-light me-0.5" id="ytd" (click)="updateAreaChartRange('ytd')">YTD</button>
                    <button class="btn btn-sm btn-outline-light" id="all" (click)="updateAreaChartRange('all')">All</button>
                  </div>
                  <div id="apex_area2" class="apex-charts">
                    <apx-chart
                      [annotations]="apexArea2.annotations!"
                      [fill]="apexArea2.fill!"
                      [markers]="apexArea2.markers!"
                      [tooltip]="apexArea2.tooltip!"
                      [series]="apexArea2.series!"
                      [chart]="apexArea2.chart!"
                      [colors]="apexArea2.colors!"
                      [dataLabels]="apexArea2.dataLabels!"
                      [stroke]="apexArea2.stroke!"
                      [grid]="apexArea2.grid!"
                      [xaxis]="apexArea2.xaxis!"
                    />
                  </div>
                </div>
              </div>
            </div>
            <!-- New Chart: Code by Frequency -->
            <div class="col-md-6">
              <div class="card h-100 shadow-sm">
                <div class="card-header bg-light">
                  <h5 class="card-title">KPIs by Frequency</h5>
                </div>
                <div class="card-body">
                  <div id="frequency_chart" class="apex-charts">
                    <apx-chart
                      [chart]="frequencyChart.chart!"
                      [series]="frequencyChart.series!"
                      [xaxis]="frequencyChart.xaxis!"
                      [yaxis]="frequencyChart.yaxis!"
                      [colors]="frequencyChart.colors!"
                      [dataLabels]="frequencyChart.dataLabels!"
                      [plotOptions]="frequencyChart.plotOptions!"
                      [tooltip]="frequencyChart.tooltip!"
                    />
                  </div>
                </div>
              </div>
            </div>
            <!-- New Chart: Code vs Targets -->
            <div class="col-md-6">
              <div class="card h-100 shadow-sm">
                <div class="card-header bg-light">
                  <h5 class="card-title">Targets vs Current Values</h5>
                </div>
                <div class="card-body">
                  <div id="target_chart" class="apex-charts">
                    <apx-chart
                      [chart]="targetChart.chart!"
                      [series]="targetChart.series!"
                      [xaxis]="targetChart.xaxis!"
                      [yaxis]="targetChart.yaxis!"
                      [colors]="targetChart.colors!"
                      [dataLabels]="targetChart.dataLabels!"
                      [plotOptions]="targetChart.plotOptions!"
                      [tooltip]="targetChart.tooltip!"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- KPIs List -->
          <div class="kpi-list-section mt-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">List of Indicators</h5>
              <button class="btn btn-primary" (click)="addKpi()" aria-label="Add a KPI">Add a KPI</button>
            </div>
            <table class="table table-hover table-striped shadow-sm">
              <thead class="table-primary">
              <tr>
                <th>Code</th>
                <th>Label</th>
                <th>Calculation Method</th>
                <th>Frequency</th>
                <th>Unit</th>
                <th>Target</th>
                <th>Current Value</th>
                <th>Active</th>
                <th>Actions</th>
              </tr>
              </thead>
              <tbody>
                @if (isLoading) {
                  <tr>
                    <td colspan="9" class="text-center">Loading indicators...</td>
                  </tr>
                } @else {
                  @for (kpi of kpis; track kpi.idIndicateur) {
                    <tr>
                      <td>{{ kpi.code }}</td>
                      <td>{{ kpi.libelle }}</td>
                      <td>{{ kpi.methodeCalcul || 'N/A' }}</td>
                      <td>{{ kpi.frequence }}</td>
                      <td>{{ kpi.unite }}</td>
                      <td>{{ kpi.cible }}</td>
                      <td>{{ kpi.currentValue ?? 'N/A' }}</td>
                      <td>{{ kpi.actif }}</td>
                      <td>
                        <button class="btn btn-sm btn-warning me-2" (click)="editKpi(kpi)" aria-label="Edit the KPI">Edit</button>
                        <button class="btn btn-sm btn-danger" (click)="deleteKpi(kpi.idIndicateur!)" [disabled]="!kpi.idIndicateur" aria-label="Delete the KPI">Delete</button>
                      </td>
                    </tr>
                  } @empty {
                    <tr>
                      <td colspan="9" class="text-center">No indicators available</td>
                    </tr>
                  }
                }
              </tbody>
            </table>
          </div>

          <!-- Form to add/edit a KPI -->
          @if (isEditing && selectedKpi) {
            <div class="kpi-form-section mt-4">
              <div class="card shadow-sm">
                <div class="card-header bg-light">
                  <h5>{{ selectedKpi.idIndicateur ? 'Edit' : 'Add' }} an Indicator</h5>
                </div>
                <div class="card-body">
                  <form (ngSubmit)="saveKpi()" #kpiForm="ngForm">
                    <div class="row g-3">
                      <div class="col-md-2">
                        <label for="code" class="form-label">Code</label>
                        <input id="code" class="form-control" [(ngModel)]="selectedKpi.code" name="code" required [disabled]="!!selectedKpi.idIndicateur" [class.is-invalid]="kpiForm.controls['code']?.invalid && kpiForm.controls['code']?.touched" />
                        <div class="invalid-feedback">The code is required.</div>
                      </div>
                      <div class="col-md-3">
                        <label for="libelle" class="form-label">Label</label>
                        <input id="libelle" class="form-control" [(ngModel)]="selectedKpi.libelle" name="libelle" required [class.is-invalid]="kpiForm.controls['libelle']?.invalid && kpiForm.controls['libelle']?.touched" />
                        <div class="invalid-feedback">The label is required.</div>
                      </div>
                      <div class="col-md-3">
                        <label for="methodeCalcul" class="form-label">Calculation Method</label>
                        <input id="methodeCalcul" class="form-control" [(ngModel)]="selectedKpi.methodeCalcul" name="methodeCalcul" />
                      </div>
                      <div class="col-md-2">
                        <label for="frequence" class="form-label">Frequency</label>
                        <select id="frequence" class="form-control" [(ngModel)]="selectedKpi.frequence" name="frequence" required [class.is-invalid]="kpiForm.controls['frequence']?.invalid && kpiForm.controls['frequence']?.touched">
                          <option value="Mensuelle">Mensuelle</option>
                          <option value="Yearly">Yearly</option>
                        </select>
                        <div class="invalid-feedback">The frequency is required.</div>
                      </div>
                      <div class="col-md-2">
                        <label for="unite" class="form-label">Unit</label>
                        <input id="unite" class="form-control" [(ngModel)]="selectedKpi.unite" name="unite" required [class.is-invalid]="kpiForm.controls['unite']?.invalid && kpiForm.controls['unite']?.touched" />
                        <div class="invalid-feedback">The unit is required.</div>
                      </div>
                      <div class="col-md-2">
                        <label for="cible" class="form-label">Target</label>
                        <input id="cible" type="number" class="form-control" [(ngModel)]="selectedKpi.cible" name="cible" required [class.is-invalid]="kpiForm.controls['cible']?.invalid && kpiForm.controls['cible']?.touched" />
                        <div class="invalid-feedback">The target is required.</div>
                      </div>
                      <div class="col-md-2">
                        <label for="currentValue" class="form-label">Current Value</label>
                        <input id="currentValue" type="number" class="form-control" [(ngModel)]="selectedKpi.currentValue" name="currentValue" />
                      </div>
                      <div class="col-md-2">
                        <label for="actif" class="form-label">Active</label>
                        <select id="actif" class="form-control" [(ngModel)]="selectedKpi.actif" name="actif" required [class.is-invalid]="kpiForm.controls['actif']?.invalid && kpiForm.controls['actif']?.touched">
                          <option value="Yes">Yes</option>
                          <option value="No">No</option>
                        </select>
                        <div class="invalid-feedback">The active status is required.</div>
                      </div>
                      <div class="col-md-6 d-flex align-items-end">
                        <button type="submit" class="btn btn-success me-2" [disabled]="!kpiForm.valid" aria-label="Save the KPI">Save</button>
                        <button type="button" class="btn btn-secondary" (click)="resetForm()" aria-label="Cancel the edit">Cancel</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          }

          <!-- Reports List -->
          <div class="report-list-section mt-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">List of Reports</h5>
              <button class="btn btn-primary" (click)="addReport()" aria-label="Add a Report">Add a Report</button>
            </div>
            <table class="table table-hover table-striped shadow-sm">
              <thead class="table-primary">
              <tr>
                <th>Title</th>
                <th>Creation Date</th>
                <th>Created By</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
              </thead>
              <tbody>
                @if (isLoading) {
                  <tr>
                    <td colspan="5" class="text-center">Loading reports...</td>
                  </tr>
                } @else {
                  @for (report of reports; track report.id) {
                    <tr>
                      <td>{{ report.title }}</td>
                      <td>{{ report.dateCreation | date:'dd/MM/yyyy' }}</td>
                      <td>{{ report.createdBy }}</td>
                      <td>{{ report.statut }}</td>
                      <td>
                        <button class="btn btn-sm btn-info me-2" (click)="viewReport(report)" aria-label="View the Report">View</button>
                        <button class="btn btn-sm btn-primary me-2" (click)="downloadPDF(report)" aria-label="Download the Report">Download PDF</button>
                        <button class="btn btn-sm btn-warning me-2" (click)="editReport(report)" aria-label="Edit the Report">Edit</button>
                        <button class="btn btn-sm btn-danger" (click)="deleteReport(report.id!)" [disabled]="!report.id" aria-label="Delete the Report">Delete</button>
                      </td>
                    </tr>
                  } @empty {
                    <tr>
                      <td colspan="5" class="text-center">No reports available</td>
                    </tr>
                  }
                }
              </tbody>
            </table>
          </div>

          <!-- Form to add/edit a Report -->
          @if (isEditingReport && selectedReport) {
            <div class="report-form-section mt-4">
              <div class="card shadow-sm">
                <div class="card-header bg-light">
                  <h5>{{ selectedReport.id ? 'Edit' : 'Add' }} a Report</h5>
                </div>
                <div class="card-body">
                  <form (ngSubmit)="saveReport()" #reportForm="ngForm">
                    <div class="row g-3">
                      <div class="col-md-4">
                        <label for="reportTitle" class="form-label">Title</label>
                        <input id="reportTitle" class="form-control" [(ngModel)]="selectedReport.title" name="title" required [class.is-invalid]="reportForm.controls['title']?.invalid && reportForm.controls['title']?.touched" />
                        <div class="invalid-feedback">The title is required.</div>
                      </div>
                      <div class="col-md-4">
                        <label for="reportContent" class="form-label">Content</label>
                        <textarea id="reportContent" class="form-control" [(ngModel)]="selectedReport.content" name="content" required [class.is-invalid]="reportForm.controls['content']?.invalid && reportForm.controls['content']?.touched"></textarea>
                        <div class="invalid-feedback">The content is required.</div>
                      </div>
                      <div class="col-md-4">
                        <label for="reportStatut" class="form-label">Status</label>
                        <select id="reportStatut" class="form-control" [(ngModel)]="selectedReport.statut" name="statut" required>
                          <option value="DRAFT">Draft</option>
                          <option value="FINAL">Final</option>
                        </select>
                      </div>
                      <div class="col-md-12">
                        <label for="kpiIds" class="form-label">KPIs to Include</label>
                        <select id="kpiIds" class="form-control" multiple [(ngModel)]="selectedKpiIds" name="kpiIds" required>
                          @for (kpi of kpis; track kpi.idIndicateur) {
                            <option [value]="kpi.idIndicateur">{{ kpi.code }} - {{ kpi.libelle }}</option>
                          }
                        </select>
                        <small class="form-text text-muted">Hold Ctrl (Windows) or Cmd (Mac) to select multiple KPIs.</small>
                      </div>
                      <div class="col-md-12 d-flex align-items-end">
                        <button type="submit" class="btn btn-success me-2" [disabled]="!reportForm.valid" aria-label="Save the Report">Save</button>
                        <button type="button" class="btn btn-secondary" (click)="resetReportForm()" aria-label="Cancel the edit">Cancel</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          }

          <!-- CSV/PDF File Upload -->
          <div class="row justify-content-center mt-4">
            <div class="col-md-6 col-lg-6">
              <div class="card shadow-sm">
                <div class="card-header bg-light">
                  <h5 class="card-title">Upload KPIs List</h5>
                </div>
                <div class="card-body pt-0">
                  <div class="d-grid">
                    <p class="text-muted">
                      Upload your KPIs list here (CSV or PDF format: code, label, calculationMethod, frequency, unit, target, currentValue).
                    </p>
                    <input type="file" id="input-file" name="input-file" accept=".csv,.pdf" (change)="handleFileChange($event)" hidden />
                    <label class="btn btn-primary mt-3" for="input-file" aria-label="Upload KPIs">Upload KPIs</label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Report Generation -->
          <div class="mt-4">
            <div class="card shadow-sm">
              <div class="card-header bg-light">
                <h5 class="card-title">Report Generation</h5>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-4">
                    <label for="reportTitleGen" class="form-label">Report Title</label>
                    <input id="reportTitleGen" class="form-control" [(ngModel)]="reportTitle" name="reportTitleGen" required placeholder="Enter the report title" />
                  </div>
                  <div class="col-md-4">
                    <label for="period" class="form-label">Period</label>
                    <select id="period" class="form-control" [(ngModel)]="selectedPeriod" name="period">
                      <option value="Mensuelle">Mensuelle</option>
                      <option value="Yearly">Yearly</option>
                    </select>
                  </div>
                  <div class="col-md-4 d-flex align-items-end">
                    <button class="btn btn-primary w-100" (click)="generateReport()" [disabled]="!reportTitle.trim()" aria-label="Generate the report">Generate Report</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
