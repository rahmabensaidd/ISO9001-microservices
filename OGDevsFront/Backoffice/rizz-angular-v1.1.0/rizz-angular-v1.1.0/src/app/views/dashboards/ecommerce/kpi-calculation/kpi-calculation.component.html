<div class="container">
  <h2>KPI Calculation and Prediction</h2>

  <!-- Custom File Upload -->
  <div class="row justify-content-center">
    <div class="col-md-6 col-lg-6">
      <div class="card">
        <div class="card-header">
          <div class="row align-items-center">
            <div class="col">
              <h4 class="card-title">Custom File Upload</h4>
            </div>
          </div>
        </div>
        <div class="card-body pt-0">
          <div class="d-grid">
            <p class="text-muted">
              Upload your CSV here, Please click "Upload CSV" Button.
            </p>
            <input
              type="file"
              id="file"
              accept=".csv"
              (change)="onFileChange($event)"
              style="display: none;"
            />
            <label for="file" class="btn btn-success">
              Upload CSV
            </label>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Buttons for Download Actions -->
  <div class="form-group">
    <button type="button" class="btn btn-success" (click)="downloadCsvTemplate()">Download CSV Template</button>
    <button type="button" class="btn btn-success" (click)="downloadPredictionsAsCsv()" [disabled]="!predictions.length">
      Download Predictions CSV
    </button>
  </div>

  <!-- Error and Success Messages -->
  <div *ngIf="error" class="alert alert-danger">{{ error }}</div>
  <div *ngIf="success" class="alert alert-success">{{ success }}</div>

  <!-- KPI Selection -->
  <div class="form-group" *ngIf="kpis.length">
    <label for="kpiSelect">Select KPI</label>
    <select id="kpiSelect" (change)="onKpiChange($event)">
      <option value="">All KPIs</option>
      <option *ngFor="let kpi of kpis" [value]="kpi.idIndicateur">
        {{ kpi.name }} ({{ kpi.unite }})
      </option>
    </select>
  </div>

  <!-- Line Chart -->
  <div *ngIf="predictions.length" class="chart-container">
    <apx-chart
      #chart
      [series]="lineChart.series"
      [chart]="lineChart.chart"
      [xaxis]="lineChart.xaxis"
      [yaxis]="lineChart.yaxis"
      [dataLabels]="lineChart.dataLabels"
      [colors]="lineChart.colors"
      [tooltip]="lineChart.tooltip"
      [grid]="lineChart.grid"
    ></apx-chart>
  </div>

  <!-- Predictions Table -->
  <div *ngIf="predictions.length" class="table-container">
    <h3>Predictions</h3>
    <table class="table">
      <thead>
      <tr>
        <th>KPI Name</th>
        <th>Date</th>
        <th>Calculated Value</th>
        <th>Predicted Value</th>
        <th>Target</th>
        <th>MAE</th>
        <th>RMSE</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let pred of predictions">
        <td>{{ kpis | findKpi: pred.indicatorId }}</td>
        <td>{{ pred.date }}</td>
        <td>{{ pred.calculatedValue | number: '1.2-2' }}</td>
        <td>{{ pred.predictedValue | number: '1.2-2' }}</td>
        <td>{{ kpis | findKpi: pred.indicatorId: 'cible' | number: '1.2-2' }}</td>
        <td>{{ pred.mae | number: '1.2-2' }}</td>
        <td>{{ pred.rmse | number: '1.2-2' }}</td>
      </tr>
      </tbody>
    </table>
  </div>
</div>

<style>
  .container {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
    background-color: #ffffff;
  }

  .form-group {
    margin-bottom: 15px;
    background-color: #ffffff;
  }

  .form-group label {
    display: block;
    margin-bottom: 5px;
  }

  select {
    padding: 8px;
    font-size: 14px;
    margin-right: 10px;
    background-color: #ffffff;
    border: 1px solid #ddd;
  }

  .btn-success {
    background-color: #28a745;
    color: white;
    border: none;
    cursor: pointer;
    padding: 8px 16px;
    font-size: 14px;
    margin-right: 10px;
  }

  .btn-success:hover {
    background-color: #218838;
  }

  .btn-success:disabled {
    background-color: #6c757d;
    cursor: not-allowed;
  }

  .alert {
    padding: 10px;
    margin: 10px 0;
    border-radius: 4px;
  }

  .alert-danger {
    background-color: #f8d7da;
    color: #721c24;
  }

  .alert-success {
    background-color: #d4edda;
    color: #155724;
  }

  .chart-container {
    margin: 20px 0;
    background-color: #ffffff;
  }

  .table-container {
    margin-top: 20px;
    background-color: #ffffff;
  }

  .table {
    width: 100%;
    border-collapse: collapse;
    background-color: #ffffff;
  }

  .table th,
  .table td {
    padding: 10px;
    border: 1px solid #ddd;
    text-align: left;
  }

  .table th {
    background-color: #f4f4f4;
  }
</style>