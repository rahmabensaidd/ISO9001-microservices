<div class="kanban-board">
  <div *ngFor="let column of columns; let i = index" class="kanban-column">
    <div class="kanban-column-header">
      <h3>{{ column.title }}</h3>
    </div>
    <div
      cdkDropList
      [id]="'column-' + i"
      [cdkDropListData]="column.tasks"
      (cdkDropListDropped)="drop($event, column)"
      class="task-list"
      [cdkDropListConnectedTo]="getColumnIds()"
    >
      <div *ngFor="let task of column.tasks" cdkDrag class="task-card" [attr.data-status]="task.status">

        <div class="task-info" *ngIf="taskInfoMap[task.id]" style="margin-bottom: 0.5rem;">
    <span class="info-badge bg-primary text-white">
      <strong>Project:</strong> {{ taskInfoMap[task.id].projectName || '-' }}
    </span>
          <span class="info-badge bg-success text-white">
      <strong>Phase:</strong> {{ taskInfoMap[task.id].phaseName || '-' }}
    </span>
          <span class="info-badge bg-info text-white">
      <strong>Operation:</strong> {{ taskInfoMap[task.id].operationName || '-' }}
    </span>
        </div>

        <!-- Task description stylée -->

          <div class="task-description-title">Task Description:</div>
        <div class="task-description-container">
          <div class="task-description-text">{{ task.taskDescription }}</div>
        </div>
        <br/>

        <!-- Ligne pour In Progress : ratio + icône + Progress Bar -->
        <div class="bug-info" *ngIf="column.title === 'In Progress'">
          <a class="bug-view-icon">{{ getBugRatio(task) }} bugs fixed</a>
          <a [routerLink]="['/bugsfortask', task.id]" class="bug-view-icon" title="View Bugs">
            <i class="fas fa-eye"></i>
          </a>
        </div>

        <!-- Ligne pour Done : "bugs" + icône -->
        <div class="bug-info" *ngIf="column.title === 'Done'">
          <a class="bug-view-icon">Bugs history</a>
          <a [routerLink]="['/bugsfortask', task.id]" class="bug-view-icon" title="View Bugs">
            <i class="fas fa-eye"></i>
          </a>
        </div>

        <div class="task-footer">
          <div class="task-status">
      <span
        class="badge rounded fw-normal px-1 mb-1 me-0.5"
        [ngClass]="getStatusClasses(task.status)"
      >
        {{ task.status || '-' }}
      </span>
          </div>

          <div *ngIf="column.title === 'In Progress' "class="add-bug-button">
      <span
        class="badge rounded fw-normal px-1 mb-1 me-0.5 bg-danger text-white btn"
        (click)="openBugModal(templatee, task.id)"
        style="cursor: pointer;"
      >
        Add Bug
      </span>
            <br />
          </div>
        </div>

      </div>

    </div>


  </div>
</div>
<ng-template #templatee let-modal>
  <div class="modal-header bg-primary text-white">
    <h5 class="modal-title">Add Bug</h5>
    <button type="button" class="btn-close btn-close-white" (click)="modal.dismiss()" aria-label="Close"></button>
  </div>

  <div class="modal-body">
    <form (ngSubmit)="addBug()" #bugForm="ngForm">
      <div class="mb-3">
        <label for="priority" class="form-label">Priority</label>
        <select
          id="priority"
          [(ngModel)]="bug.priority"
          name="priority"
          class="form-select"
          required
          [ngClass]="{'is-invalid': bugForm.submitted && bugForm.controls['priority']?.invalid}"
        >
          <option value="">Select priority</option>
          <option value="Critical">Critical</option>
          <option value="Medium">Medium</option>
          <option value="High">High</option>
        </select>
        <div class="invalid-feedback">Priority is required.</div>
      </div>

      <div class="mb-3">
        <label for="description" class="form-label">Enter Description (log, source code, or error message)</label>
        <textarea
          id="description"
          [(ngModel)]="bug.description"
          name="description"
          class="form-control"
          rows="3"
          required
          [ngClass]="{'is-invalid': bugForm.submitted && bugForm.controls['description']?.invalid}"
        ></textarea>
        <div class="invalid-feedback">Description is required.</div>
      </div>

      <div class="mb-3">
        <label for="sourceIssue" class="form-label">Source Issue</label>
        <select
          id="sourceIssue"
          [(ngModel)]="bug.source_issue"
          name="source_issue"
          class="form-select"
          required
          [ngClass]="{'is-invalid': bugForm.submitted && bugForm.controls['source_issue']?.invalid}"
        >
          <option value="">Select source issue</option>
          <option value="In-House">In-House</option>
          <option value="Alpha">Alpha</option>
          <option value="Support">Support</option>
        </select>
        <div class="invalid-feedback">Source Issue is required.</div>
      </div>

      <!-- Move modal-footer OUTSIDE modal-body and form stays intact -->
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" (click)="modal.dismiss()">Close</button>
        <button type="submit" class="btn btn-success" [disabled]="!bugForm.valid">
          <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          Add Bug
        </button>
      </div>
    </form>
  </div>
</ng-template>


