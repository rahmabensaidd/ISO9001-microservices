<div class="row">
  <!-- Filtre par utilisateur et Calendrier -->
  <div class="col-lg-12 mb-4">
    <div class="card">
      <div class="card-body">
        <h4 class="card-title mb-4">Meeting Calendar</h4>
        <div class="mb-3 row">
          <label for="userFilter" class="col-sm-3 col-form-label text-end fw-medium">Filter by Client :</label>
          <div class="col-sm-9">
            <select
              class="form-select"
              id="userFilter"
              [(ngModel)]="selectedUserFilter"
              (change)="onUserFilterChange()"
            >
              <option value="">All clients</option>
              @for (user of users; track user.id) {
                <option [value]="user.id">{{ user.username }}</option>
              }
            </select>
          </div>
        </div>
        <full-calendar [options]="calendarOptions"></full-calendar>
      </div>
    </div>
  </div>

  <!-- List of Meetings -->
  <div class="col-lg-12">
    <div class="card shadow-sm border-0">
      <div class="card-body p-4">
        <!-- Header -->
        <h2 class="section-header d-flex align-items-center mb-4 border-bottom pb-2">
          <i class="las la-calendar me-2 fs-5 text-primary"></i>
          <span class="fs-5 text-dark">List of Meetings</span>
          <a class="btn btn-primary ms-auto" (click)="openAddMeetingModal(addMeetingModal)">
            <i class="fa-solid fa-plus me-1"></i> Add a meeting
          </a>
        </h2>

        <!-- Loading State -->
        @if (!meetings) {
          <div class="text-center text-muted mb-4">
            <i class="las la-spinner la-spin me-2"></i>Loading, please wait...
          </div>
        }

        <!-- No Meetings Message -->
        @if (meetings && meetings.length === 0) {
          <div class="alert alert-info">
            No meetings found.
          </div>
        }

        <!-- Meetings Table -->
        @if (meetings && meetings.length > 0) {
          <div class="table-responsive">
            <table class="table datatable table-striped">
              <thead class="table-light">
              <tr>
                <th>Status</th>
                <th>Date</th>
                <th>Hour</th>
                <th>Duration (min)</th>
                <th>Link</th>
                <th>Password</th>
                <th>Client</th>
                <th>Actions</th>
              </tr>
              </thead>
              <tbody>
                @for (meeting of displayedMeetings; track meeting.meetingid) {
                  <tr class="align-middle">
                    <td>{{ meeting.meetingStatus }}</td>
                    <td>{{ meeting.meetingDate | date }}</td>
                    <td>{{ meeting.meetingTime }}</td>
                    <td>{{ meeting.meetingDuration }}</td>
                    <td>
                      <a class="btn btn-primary btn-sm" [href]="meeting.meetingLink" target="_blank">
                        <i class="las la-video me-1"></i> Join
                      </a>
                    </td>
                    <td>{{ meeting.password || 'N/A' }}</td>
                    <td>{{ getClientName(meeting) }}</td>
                    <td>
                      <button class="btn btn-primary btn-sm me-1" (click)="openModifyMeetingModal(modifyMeetingModal, meeting)">
                        <i class="las la-pen"></i> Modifier
                      </button>
                      <button class="btn btn-success btn-sm me-1" (click)="updateMeetingStatus(meeting.meetingid!, meeting.meetingStatus)">
                        <i class="las la-sync"></i> Changer Statut
                      </button>
                      <button class="btn btn-danger btn-sm" (click)="deleteMeeting(meeting.meetingid!)">
                        <i class="las la-trash-alt"></i> Supprimer
                      </button>
                    </td>
                  </tr>
                }
              </tbody>
            </table>

            <div class="d-flex justify-content-between p-2">
              <ngb-pagination
                [collectionSize]="meetingsCollectionSize"
                [(page)]="meetingsPage"
                [pageSize]="meetingsPageSize"
                (pageChange)="refreshMeetings()"
                [boundaryLinks]="false"
                [maxSize]="0"
              >
                <ng-template ngbPaginationPrevious>
                  <span>« </span>
                </ng-template>
                <ng-template ngbPaginationNext>
                  <span> »</span>
                </ng-template>
              </ngb-pagination>

              <select
                class="form-select"
                style="width: auto"
                [(ngModel)]="meetingsPageSize"
                (ngModelChange)="refreshMeetings()"
              >
                <option [ngValue]="2">2 items per page</option>
                <option [ngValue]="4">4 items per page</option>
                <option [ngValue]="6">6 items per page</option>
              </select>
            </div>
          </div>
        }
      </div>
    </div>
  </div>

  <!-- Liste des tickets pour ROLE_ADMIN -->
  <div class="col-lg-12 mt-4">
    <div class="card shadow-sm border-0">
      <div class="card-body p-4">
        <!-- Header -->
        <h2 class="section-header d-flex align-items-center mb-4 border-bottom pb-2">
          <i class="las la-ticket-alt me-2 fs-5 text-primary"></i>
          <span class="fs-5 text-dark">All Tickets</span>
        </h2>

        <!-- Loading State -->
        @if (!adminTickets) {
          <div class="text-center text-muted mb-4">
            <i class="las la-spinner la-spin me-2"></i>Loading, please wait...
          </div>
        }

        <!-- No Tickets Message -->
        @if (adminTickets && adminTickets.length === 0) {
          <div class="alert alert-info">
            No tickets found.
          </div>
        }

        <!-- Tickets Table -->
        @if (adminTickets && adminTickets.length > 0) {
          <div class="table-responsive">
            <table class="table datatable table-striped">
              <thead class="table-light">
              <tr>
                <th>Status</th>
                <th>Creation Date</th>
                <th>Title</th>
                <th>Type</th>
              </tr>
              </thead>
              <tbody>
                @for (ticket of displayedAdminTickets; track ticket.id) {
                  <tr class="align-middle">
                    <td>{{ ticket.status }}</td>
                    <td>{{ ticket.createdAt | date }}</td>
                    <td>{{ ticket.title }}</td>
                    <td>{{ ticket.type }}</td>
                  </tr>
                }
              </tbody>
            </table>

            <div class="d-flex justify-content-between p-2">
              <ngb-pagination
                [collectionSize]="adminTicketsCollectionSize"
                [(page)]="adminTicketsPage"
                [pageSize]="adminTicketsPageSize"
                (pageChange)="refreshAdminTickets()"
                [boundaryLinks]="false"
                [maxSize]="0"
              >
                <ng-template ngbPaginationPrevious>
                  <span>« </span>
                </ng-template>
                <ng-template ngbPaginationNext>
                  <span> »</span>
                </ng-template>
              </ngb-pagination>

              <select
                class="form-select"
                style="width: auto"
                [(ngModel)]="adminTicketsPageSize"
                (ngModelChange)="refreshAdminTickets()"
              >
                <option [ngValue]="2">2 items per page</option>
                <option [ngValue]="4">4 items per page</option>
                <option [ngValue]="6">6 items per page</option>
              </select>
            </div>
          </div>
        }
      </div>
    </div>
  </div>
</div>

<!-- Modale pour ajouter un meeting -->
<ng-template #addMeetingModal let-modal>
  <div class="modal-header">
    <h6 class="modal-title m-0">Add a new Meeting</h6>
    <button type="button" class="btn-close" (click)="modal.dismiss()" aria-label="Close"></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="meetingForm" (ngSubmit)="createMeeting()">
      <div class="mb-3 row">
        <label for="meetingTitle" class="col-sm-3 col-form-label text-end fw-medium">Title :</label>
        <div class="col-sm-9">
          <input
            type="text"
            formControlName="title"
            class="form-control"
            id="meetingTitle"
            [ngClass]="{ 'is-invalid': submitted && form['title'].errors }"
          />
          @if (submitted && form['title'].errors) {
            <div class="invalid-feedback">
              Le titre est requis
            </div>
          }
        </div>
      </div>
      <div class="mb-3 row">
        <label for="meetingDate" class="col-sm-3 col-form-label text-end fw-medium">Date :</label>
        <div class="col-sm-9">
          <input
            type="date"
            formControlName="meetingDate"
            class="form-control"
            id="meetingDate"
            [ngClass]="{ 'is-invalid': submitted && form['meetingDate'].errors }"
          />
          @if (submitted && form['meetingDate'].errors) {
            <div class="invalid-feedback">
              La date est requise
            </div>
          }
        </div>
      </div>
      <div class="mb-3 row">
        <label for="meetingTime" class="col-sm-3 col-form-label text-end fw-medium">Hour :</label>
        <div class="col-sm-9">
          <input
            type="time"
            formControlName="meetingTime"
            class="form-control"
            id="meetingTime"
            [ngClass]="{ 'is-invalid': submitted && form['meetingTime'].errors }"
          />
          @if (submitted && form['meetingTime'].errors) {
            <div class="invalid-feedback">
              L'heure est requise
            </div>
          }
        </div>
      </div>
      <div class="mb-3 row">
        <label for="meetingDuration" class="col-sm-3 col-form-label text-end fw-medium">Duration (min) :</label>
        <div class="col-sm-9">
          <input
            type="number"
            formControlName="meetingDuration"
            class="form-control"
            id="meetingDuration"
            [ngClass]="{ 'is-invalid': submitted && form['meetingDuration'].errors }"
          />
          @if (submitted && form['meetingDuration'].errors) {
            <div class="invalid-feedback">
              La durée est requise
            </div>
          }
        </div>
      </div>
      <div class="mb-3 row">
        <label for="meetingPassword" class="col-sm-3 col-form-label text-end fw-medium">Mot de passe :</label>
        <div class="col-sm-9">
          <div class="input-group">
            <input
              [type]="showAddPassword ? 'text' : 'password'"
              formControlName="password"
              class="form-control"
              id="meetingPassword"
            />
          </div>
        </div>
      </div>
      <div class="mb-3 row">
        <label for="clientId" class="col-sm-3 col-form-label text-end fw-medium">Client :</label>
        <div class="col-sm-9">
          <select
            formControlName="clientId"
            class="form-select"
            id="clientId"
            [ngClass]="{ 'is-invalid': submitted && form['clientId'].errors }"
          >
            <option value="">Sélectionner un client</option>
            @for (user of users; track user.id) {
              <option [value]="user.id">{{ user.username }}</option>
            }
          </select>
          @if (submitted && form['clientId'].errors) {
            <div class="invalid-feedback">
              Select Client
            </div>
          }
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary btn-sm" (click)="createMeeting()">Enregistrer</button>
    <button type="button" class="btn btn-outline-danger btn-sm" (click)="modal.dismiss()">Fermer</button>
  </div>
</ng-template>

<!-- Modale pour modifier un meeting -->
<ng-template #modifyMeetingModal let-modal>
  <div class="modal-header">
    <h6 class="modal-title m-0">Edit Meeting</h6>
    <button type="button" class="btn-close" (click)="modal.dismiss()" aria-label="Close"></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="modifyForm" (ngSubmit)="modifyMeeting()">
      <div class="mb-3 row">
        <label for="modifyMeetingStatus" class="col-sm-3 col-form-label text-end fw-medium">Status :</label>
        <div class="col-sm-9">
          <select
            formControlName="meetingStatus"
            class="form-select"
            id="modifyMeetingStatus"
            [ngClass]="{ 'is-invalid': submitted && modifyFormControls['meetingStatus'].errors }"
          >
            <option value="">Select Status</option>
            <option value="PLANNED">Planed</option>
            <option value="IN_PROGRESS">Now</option>
            <option value="COMPLETED">Finished</option>
          </select>
          @if (submitted && modifyFormControls['meetingStatus'].errors) {
            <div class="invalid-feedback">
              Le statut est requis
            </div>
          }
        </div>
      </div>
      <div class="mb-3 row">
        <label for="modifyMeetingDate" class="col-sm-3 col-form-label text-end fw-medium">Date :</label>
        <div class="col-sm-9">
          <input
            type="date"
            formControlName="meetingDate"
            class="form-control"
            id="modifyMeetingDate"
            [ngClass]="{ 'is-invalid': submitted && modifyFormControls['meetingDate'].errors }"
          />
          @if (submitted && modifyFormControls['meetingDate'].errors) {
            <div class="invalid-feedback">
              La date est requise
            </div>
          }
        </div>
      </div>
      <div class="mb-3 row">
        <label for="modifyMeetingTime" class="col-sm-3 col-form-label text-end fw-medium">Hour :</label>
        <div class="col-sm-9">
          <input
            type="time"
            formControlName="meetingTime"
            class="form-control"
            id="modifyMeetingTime"
            [ngClass]="{ 'is-invalid': submitted && modifyFormControls['meetingTime'].errors }"
          />
          @if (submitted && modifyFormControls['meetingTime'].errors) {
            <div class="invalid-feedback">
              L'heure est requise
            </div>
          }
        </div>
      </div>
      <div class="mb-3 row">
        <label for="modifyMeetingDuration" class="col-sm-3 col-form-label text-end fw-medium">Duration (min) :</label>
        <div class="col-sm-9">
          <input
            type="number"
            formControlName="meetingDuration"
            class="form-control"
            id="modifyMeetingDuration"
            [ngClass]="{ 'is-invalid': submitted && modifyFormControls['meetingDuration'].errors }"
          />
          @if (submitted && modifyFormControls['meetingDuration'].errors) {
            <div class="invalid-feedback">
              La durée est requise
            </div>
          }
        </div>
      </div>
      <div class="mb-3 row">
        <label for="modifyMeetingPassword" class="col-sm-3 col-form-label text-end fw-medium">Password :</label>
        <div class="col-sm-9">
          <div class="input-group">
            <input
              [type]="showModifyPassword ? 'text' : 'password'"
              formControlName="password"
              class="form-control"
              id="modifyMeetingPassword"
            />
            <button
              type="button"
              class="btn btn-outline-secondary"
              (click)="toggleModifyPassword()"
            >
              <i class="fa-solid" [ngClass]="showModifyPassword ? 'fa-eye-slash' : 'fa-eye'"></i>
            </button>
          </div>
        </div>
      </div>
      <div class="mb-3 row">
        <label for="modifyClientId" class="col-sm-3 col-form-label text-end fw-medium">Client :</label>
        <div class="col-sm-9">
          <select
            formControlName="clientId"
            class="form-select"
            id="modifyClientId"
            [ngClass]="{ 'is-invalid': submitted && modifyFormControls['clientId'].errors }"
          >
            <option value="">Sélectionner un client</option>
            @for (user of users; track user.id) {
              <option [value]="user.id">{{ user.username }}</option>
            }
          </select>
          @if (submitted && modifyFormControls['clientId'].errors) {
            <div class="invalid-feedback">
              Select Client
            </div>
          }
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary btn-sm" (click)="modifyMeeting()">Enregistrer</button>
    <button type="button" class="btn btn-outline-danger btn-sm" (click)="modal.dismiss()">Fermer</button>
  </div>
</ng-template>
