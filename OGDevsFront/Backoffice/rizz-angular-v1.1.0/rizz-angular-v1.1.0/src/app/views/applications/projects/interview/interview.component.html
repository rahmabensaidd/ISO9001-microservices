<div class="container mt-5">
  <!-- Section for Google Calendar synchronization -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-warning text-dark">
      <h2 class="mb-0">Google Calendar Synchronization</h2>
    </div>
    <div class="card-body text-center">
      <p *ngIf="googleAccessToken" class="text-success mb-3">
        Successfully connected to Google Calendar!
      </p>
      <asl-google-signin-button
        type="standard"
        size="large"
      ></asl-google-signin-button>
    </div>
  </div>

  <!-- Main title -->
  <h1 class="mb-4 text-center">Interview Management</h1>

  <!-- Form for creating or editing an interview -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">
      <h2 class="mb-0">{{ isEditing ? 'Edit an Interview' : 'Create a New Interview' }}</h2>
    </div>
    <div class="card-body">
      <form>
        <!-- Interview name -->
        <div class="mb-3">
          <label for="interviewName" class="form-label">Interview Name</label>
          <input
            type="text"
            class="form-control"
            id="interviewName"
            [(ngModel)]="newInterview.name"
            name="interviewName"
            placeholder="Enter the interview name"
            required
          />
        </div>

        <!-- Description -->
        <div class="mb-3">
          <label for="interviewDescription" class="form-label">Description</label>
          <textarea
            class="form-control"
            id="interviewDescription"
            [(ngModel)]="newInterview.description"
            name="interviewDescription"
            placeholder="Enter a description"
            rows="3"
            required
          ></textarea>
        </div>

        <!-- Interview type -->
        <div class="mb-3">
          <label for="interviewType" class="form-label">Interview Type</label>
          <select
            class="form-select"
            id="interviewType"
            [(ngModel)]="newInterview.interviewType"
            name="interviewType"
            required
          >
            <option value="EMBAUCHE">Hiring</option>
            <option value="ANNUEL">Annual</option>
          </select>
        </div>

        <!-- Job offer selection -->
        <div class="mb-3">
          <label for="jobOffer" class="form-label">Job Offer</label>
          <select
            class="form-select"
            id="jobOffer"
            [(ngModel)]="selectedJobOfferId"
            name="jobOffer"
            (change)="onJobOfferChange($event)"
            required
            [disabled]="isLoadingJobOffers"
          >
            <option value="" disabled selected>Select a job offer</option>
            <option *ngFor="let offer of jobOffers" [value]="offer.id">
              {{ offer.title }}
            </option>
          </select>
          <div *ngIf="isLoadingJobOffers" class="spinner-border spinner-border-sm text-primary mt-2" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>

        <!-- Candidate selection -->
        <div class="mb-3">
          <label for="candidate" class="form-label">Candidate</label>
          <select
            class="form-select"
            id="candidate"
            [(ngModel)]="selectedCandidateId"
            name="candidate"
            required
            [disabled]="isLoadingCandidates || candidates.length === 0"
          >
            <option value="" disabled selected>Select a candidate</option>
            <option *ngFor="let candidate of candidates" [value]="candidate.id">
              {{ candidate.firstName }} {{ candidate.lastName }}
            </option>
          </select>
          <div *ngIf="isLoadingCandidates" class="spinner-border spinner-border-sm text-primary mt-2" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>

        <!-- Date selection -->
        <div class="mb-3">
          <label for="interviewDate" class="form-label">Interview Date and Time</label>
          <select
            class="form-select"
            id="interviewDate"
            [(ngModel)]="newInterview.interviewDate"
            name="interviewDate"
            required
          >
            <option value="" disabled selected>Select a time slot</option>
            <option *ngFor="let slot of availableSlots" [value]="slot">
              {{ slot | date:'medium' }}
            </option>
          </select>
        </div>

        <!-- Action buttons -->
        <div class="d-flex gap-2">
          <button
            type="button"
            class="btn btn-primary"
            (click)="isEditing ? updateInterview() : createInterview()"
          >
            {{ isEditing ? 'Update' : 'Create' }}
          </button>
          <button type="button" class="btn btn-secondary" (click)="resetForm()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- FullCalendar calendar -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-success text-white">
      <h2 class="mb-0">Interview Calendar</h2>
    </div>
    <div class="card-body">
      <full-calendar [options]="calendarOptions"></full-calendar>
    </div>
  </div>

  <!-- List of interviews -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-info text-white">
      <h2 class="mb-0">List of Interviews</h2>
    </div>
    <div class="card-body">
      <table class="table table-striped table-hover">
        <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
          <th>Date</th>
          <th>Type</th>
          <th>Candidate</th>
          <th>Job Offer</th>
          <th>Timeline</th>
          <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let interview of interviews">
          <td>{{ interview.name }}</td>
          <td>{{ interview.description }}</td>
          <td>{{ interview.interviewDate | date:'medium' }}</td>
          <td>{{ interview.interviewType }}</td>
          <td>{{ interview.candidate?.firstName }} {{ interview.candidate?.lastName }}</td>
          <td>{{ interview.jobOffer?.title }}</td>
          <td>
            <button class="btn btn-sm btn-info" (click)="showCandidateTimeline(interview)">
              <i class="fas fa-search"></i>
            </button>
          </td>
          <td>
            <button class="btn btn-sm btn-warning me-2" (click)="editInterview(interview)">
              Edit
            </button>
            <button class="btn btn-sm btn-danger" (click)="deleteInterview(interview.idInterview!)">
              Delete
            </button>
          </td>
        </tr>
        <tr *ngIf="interviews.length === 0">
          <td colspan="8" class="text-center">No interviews found.</td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Timeline modal -->
  <div class="modal fade" [ngClass]="{'show d-block': showTimeline}" tabindex="-1" role="dialog" aria-labelledby="timelineModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="timelineModalLabel">Timeline for {{ selectedCandidateName }}</h5>
          <button type="button" class="btn-close" (click)="closeTimeline()" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="card">
            <div class="card-header">
              <h4 class="card-title">Timeline</h4>
            </div>
            <div class="card-body px-0 pt-0">
              <ngx-simplebar class="activity p-3 pt-0" style="height: 500px">
                <div *ngFor="let item of selectedCandidateActivities" class="activity-info">
                  <div class="icon-info-activity">
                    <i class="{{ item.icon }}"></i>
                  </div>
                  <div class="activity-info-text">
                    <div class="d-flex justify-content-between align-items-center">
                      <h6 class="m-0 w-75">{{ item.title }}</h6>
                      <span class="text-muted d-block">{{ item.time | date:'medium' }}</span>
                    </div>
                    <p class="text-muted mt-3">{{ item.description }}</p>
                    <span *ngFor="let badge of item.badges" class="badge badge-soft-secondary me-1">{{ badge }}</span>
                    <div *ngIf="item.action" class="mt-2">
                      <button class="btn btn-sm btn-primary" (click)="item.action.callback && item.action.callback()">
                        {{ item.action.label }}
                      </button>
                    </div>
                  </div>
                </div>
                <div *ngIf="selectedCandidateActivities.length === 0" class="text-center">
                  No activities found for this candidate.
                </div>
              </ngx-simplebar>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeTimeline()">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>
