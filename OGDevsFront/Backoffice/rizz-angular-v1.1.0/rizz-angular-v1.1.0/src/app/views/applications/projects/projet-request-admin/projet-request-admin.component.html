<div class="row">
  <!-- Liste de toutes les demandes de projet -->
  <div class="col-lg-12">
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4 class="card-title">
            <i class="las la-list-alt"></i> All Project Requests
          </h4>
        </div>
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
            <tr>
              <th><i class="las la-envelope"></i> Email</th>
              <th><i class="las la-euro-sign"></i> Budget (€)</th>
              <th><i class="las la-calendar-day"></i> Start Date</th>
              <th><i class="las la-calendar-times"></i>End Date</th>
              <th><i class="las la-align-left"></i> Description</th>
              <th><i class="las la-info-circle"></i> Status</th>
              <th><i class="las la-user"></i> Client</th>
              <th><i class="las la-cog"></i> Actions</th>
            </tr>
            </thead>
            <tbody>
              @for (projetRequest of projetRequests; track projetRequest.id) {
                <tr>
                  <td>{{ projetRequest.email }}</td>
                  <td>{{ projetRequest.budgetProposedByClient | number:'1.2-2' }}</td>
                  <td>{{ projetRequest.desiredStartDate | date:'dd/MM/yyyy' }}</td>
                  <td>{{ projetRequest.desiredEndDate | date:'dd/MM/yyyy' }}</td>
                  <td>{{ projetRequest.description ?? 'N/A' }}</td>
                  <td>
                    <span [ngClass]="{
                      'badge bg-warning': projetRequest.statut === StatutRequestProjet.EN_ATTENTE,
                      'badge bg-success': projetRequest.statut === StatutRequestProjet.ACCEPTEE,
                      'badge bg-danger': projetRequest.statut === StatutRequestProjet.REFUSEE
                    }">
                      <i class="las la-clock" *ngIf="projetRequest.statut === StatutRequestProjet.EN_ATTENTE"></i>
                      <i class="las la-check-circle" *ngIf="projetRequest.statut === StatutRequestProjet.ACCEPTEE"></i>
                      <i class="las la-times-circle" *ngIf="projetRequest.statut === StatutRequestProjet.REFUSEE"></i>
                      {{ projetRequest.statut }}
                    </span>
                  </td>
                  <td>{{ projetRequest.client?.username || 'N/A' }}</td>
                  <td>
                    <div class="d-flex flex-wrap gap-2">
                      <button class="btn btn-primary btn-sm"
                              (click)="openModifyProjetRequestModal(modifyProjetRequestModal, projetRequest)">
                        <i class="las la-pen"></i> Modifier
                      </button>
                      <button class="btn btn-danger btn-sm"
                              (click)="deleteProjetRequest(projetRequest.id!)">
                        <i class="las la-trash-alt"></i> Supprimer
                      </button>
                      <button class="btn btn-success btn-sm"
                              (click)="acceptProjetRequest(projetRequest.id!)">
                        <i class="las la-check"></i> Accepter
                      </button>
                      <button class="btn btn-info btn-sm"
                              (click)="estimateBudgetForProject(projetRequest)">
                        <i class="las la-calculator"></i> Budget
                      </button>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Statistiques des projets -->
  <div class="col-lg-12 mt-4">
    <div class="card">
      <div class="card-body">
        <h4 class="card-title mb-4">
          <i class="las la-chart-bar"></i> Project Statistics
        </h4>
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
            <tr>
              <th><i class="las la-project-diagram"></i> Project Type </th>
              <th><i class="las la-hashtag"></i> Total Number </th>
              <th><i class="las la-money-bill-wave"></i> Budget Moyen (€)</th>
            </tr>
            </thead>
            <tbody>
              @for (stat of projectStats; track stat.id) {
                <tr>
                  <td>{{ stat.projectType ?? 'N/A' }}</td>
                  <td>{{ stat.totalProjects ?? 0 }}</td>
                  <td>{{ stat.averageBudget != null ? (stat.averageBudget | number:'1.2-2') : 'N/A' }}</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modale pour modifier une demande de projet -->
<ng-template #modifyProjetRequestModal let-modal>
  <div class="modal-header">
    <h6 class="modal-title m-0">
      <i class="las la-edit"></i> Modifier une Demande de Projet
    </h6>
    <button type="button" class="btn-close" (click)="modal.dismiss()" aria-label="Close"></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="modifyForm" (ngSubmit)="modifyProjetRequest()">
      <div class="mb-3 row">
        <label for="modifyEmail" class="col-sm-3 col-form-label text-end fw-medium">
          <i class="las la-envelope"></i> Email :
        </label>
        <div class="col-sm-9">
          <input type="email" formControlName="email" class="form-control" id="modifyEmail"
                 [ngClass]="{ 'is-invalid': submitted && modifyFormControls['email'].errors }" />
          @if (submitted && modifyFormControls['email'].errors) {
            <div class="invalid-feedback">
              <i class="las la-exclamation-circle"></i> L'email est requis et doit être valide
            </div>
          }
        </div>
      </div>
      <div class="mb-3 row">
        <label for="modifyBudget" class="col-sm-3 col-form-label text-end fw-medium">
          <i class="las la-euro-sign"></i> Budget (€) :
        </label>
        <div class="col-sm-9">
          <input type="number" formControlName="budgetProposedByClient" class="form-control" id="modifyBudget"
                 [ngClass]="{ 'is-invalid': submitted && modifyFormControls['budgetProposedByClient'].errors }" />
          @if (submitted && modifyFormControls['budgetProposedByClient'].errors) {
            <div class="invalid-feedback">
              <i class="las la-exclamation-circle"></i> Le budget est requis et doit être positif
            </div>
          }
        </div>
      </div>
      <div class="mb-3 row">
        <label for="modifyStartDate" class="col-sm-3 col-form-label text-end fw-medium">
          <i class="las la-calendar-day"></i> Date de Début :
        </label>
        <div class="col-sm-9">
          <input type="date" formControlName="desiredStartDate" class="form-control" id="modifyStartDate"
                 [ngClass]="{ 'is-invalid': submitted && modifyFormControls['desiredStartDate'].errors }" />
          @if (submitted && modifyFormControls['desiredStartDate'].errors) {
            <div class="invalid-feedback">
              <i class="las la-exclamation-circle"></i> La date de début est requise
            </div>
          }
        </div>
      </div>
      <div class="mb-3 row">
        <label for="modifyEndDate" class="col-sm-3 col-form-label text-end fw-medium">
          <i class="las la-calendar-times"></i> Date de Fin :
        </label>
        <div class="col-sm-9">
          <input type="date" formControlName="desiredEndDate" class="form-control" id="modifyEndDate"
                 [ngClass]="{ 'is-invalid': submitted && modifyFormControls['desiredEndDate'].errors }" />
          @if (submitted && modifyFormControls['desiredEndDate'].errors) {
            <div class="invalid-feedback">
              <i class="las la-exclamation-circle"></i> La date de fin est requise
            </div>
          }
        </div>
      </div>
      <div class="mb-3 row">
        <label for="modifyHeuresPrevues" class="col-sm-3 col-form-label text-end fw-medium">
          <i class="las la-clock"></i> Heures Prévues :
        </label>
        <div class="col-sm-9">
          <input type="number" formControlName="heuresPrevues" class="form-control" id="modifyHeuresPrevues" />
        </div>
      </div>
      <div class="mb-3 row">
        <label for="modifyDescription" class="col-sm-3 col-form-label text-end fw-medium">
          <i class="las la-align-left"></i> Description :
        </label>
        <div class="col-sm-9">
          <textarea formControlName="description" class="form-control" id="modifyDescription" rows="4"></textarea>
        </div>
      </div>
      <div class="mb-3 row">
        <label for="modifyStatut" class="col-sm-3 col-form-label text-end fw-medium">
          <i class="las la-info-circle"></i> Statut :
        </label>
        <div class="col-sm-9">
          <select formControlName="statut" class="form-select" id="modifyStatut"
                  [ngClass]="{ 'is-invalid': submitted && modifyFormControls['statut'].errors }">
            <option value="">Sélectionner un statut</option>
            <option value="EN_ATTENTE">En attente</option>
            <option value="ACCEPTEE">Acceptée</option>
            <option value="REFUSEE">Refusée</option>
          </select>
          @if (submitted && modifyFormControls['statut'].errors) {
            <div class="invalid-feedback">
              <i class="las la-exclamation-circle"></i> Le statut est requis
            </div>
          }
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary btn-sm" (click)="modifyProjetRequest()">
      <i class="las la-save"></i> Enregistrer
    </button>
    <button type="button" class="btn btn-outline-danger btn-sm" (click)="modal.dismiss()">
      <i class="las la-times"></i> Fermer
    </button>
  </div>
</ng-template>
