<app-notification></app-notification>

<!-- List View -->
<div class="container my-5" *ngIf="!selectedNonConformity">
  <div class="card shadow-sm border-0">
    <div class="card-body p-4">
      <!-- Header -->
      <h2 class="section-header d-flex align-items-center mb-4 border-bottom pb-2">
        <i class="las la-exclamation-circle me-2 fs-5 text-primary"></i>
        <span class="fs-5 text-dark">Non-Conformities Management</span>
      </h2>

      <!-- Loading State -->
      <div *ngIf="loading" class="text-center text-muted mb-4">
        <i class="las la-spinner la-spin me-2"></i>Loading, please wait...
      </div>

      <!-- Buttons -->
      <div class="button-container mb-4">
        <button class="btn btn-primary me-2" (click)="openAddModal()" [disabled]="loading">
          <i class="las la-plus-circle me-2"></i>Add Non-Conformance
        </button>
        <button class="btn btn-primary me-2" (click)="toggleChatbotModal()">
          <i class="las la-robot me-2"></i>Open AI Assistant
        </button>
        <button class="btn btn-primary" (click)="navigateToIsoClauses()">
          <i class="las la-book me-2"></i>Check ISO Clauses
        </button>
      </div>

      <!-- No Non-Conformities Message -->
      <div *ngIf="nonConformities.length === 0 && !loading" class="alert alert-info">
        No non-conformities found.
      </div>

      <!-- Non-Conformities Table -->
      <div class="table-responsive" *ngIf="nonConformities.length > 0 && !loading">
        <table class="table datatable table-striped">
          <thead class="table-light">
          <tr>
            <th>Source</th>
            <th>Type</th>
            <th>Description</th>
            <th>Date Created</th>
            <th>Detected By</th>
            <th>Date Detected</th>
            <th>Status</th>
            <th>Indicator Code</th>
            <th class="text-end">Actions</th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let nc of nonConformities" (click)="viewNonConformityDetails(nc.idNonConformity!)" class="align-middle">
            <td>{{ nc.source }}</td>
            <td>{{ nc.type }}</td>
            <td>{{ nc.description }}</td>
            <td>{{ nc.dateCreated }}</td>
            <td>{{ nc.detectedBy || 'N/A' }}</td>
            <td>{{ nc.dateDetected || 'N/A' }}</td>
            <td>
                <span class="badge badge-lg" [ngClass]="{
                  'bg-danger': nc.status === 'OPEN',
                  'bg-warning text-dark': nc.status === 'IN_PROGRESS',
                  'bg-success': nc.status === 'FIXED'
                }">
                  {{ nc.status }}
                </span>
            </td>
            <td>{{ nc.indicator?.code || 'N/A' }}</td>
            <td class="text-end">
              <button
                class="btn btn-outline-secondary btn-sm"
                *ngIf="nc && nc.status !== 'FIXED'"
                (click)="openFixModal(nc, fixNonConformityModal); $event.stopPropagation()"
              >
                <i class="las la-tools me-2"></i>Fix Non-Conformity
              </button>
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <!-- Indicator Sections -->
      <div class="section-item border-0 mb-3 shadow-sm" *ngIf="!loading">
        <h2 class="section-header">
          <span>
            <i class="las la-chart-bar me-2"></i>Indicator Details
          </span>
        </h2>
        <div class="section-content">
          <div class="section-body">
            <!-- Indicator IND-MAG-02 -->
            <ng-container *ngIf="indicators && indicators.length > 0">
              <ng-container *ngFor="let indicator of indicators">
                <div *ngIf="indicator.code === 'IND-MAG-02'" class="card mb-3 shadow-sm">
                  <div class="card-body">
                    <h5 class="card-title">{{ indicator.libelle || 'N/A' }} ({{ indicator.code }})</h5>
                    <div class="row justify-content-center">
                      <div class="col-md-6">
                        <div class="size-3">
                          <div
                            id="ind-mag-02-gauge"
                            class="gauge"
                            [appJustGage]="{
                              label: indicator.unite || 'Value',
                              value: indicator.currentValue !== null ? indicator.currentValue : 0,
                              min: 0,
                              max: indicator.cible !== null ? indicator.cible : 100,
                              decimals: 2,
                              gaugeWidthScale: 0.6,
                              pointer: true,
                              gaugeColor: ['rgba(42, 118, 244, .1)'],
                              levelColors: indicator.status === 'OK' ? ['#22c55e'] : ['#ff0000'],
                              pointerOptions: {
                                toplength: 10,
                                bottomlength: 10,
                                bottomwidth: 2,
                                color: '#ff5da0',
                                stroke: '#ffffff',
                                stroke_width: 3,
                                stroke_linecap: 'round'
                              },
                              counter: true
                            }"
                          ></div>
                        </div>
                      </div>
                    </div>
                    <div class="mt-3 text-center">
                      <strong>Status: </strong>
                      <span class="badge badge-lg" [ngClass]="{
                        'bg-success': indicator.status === 'OK',
                        'bg-danger': indicator.status === 'CRITICAL'
                      }">
                        {{ indicator.status || 'N/A' }}
                      </span>
                    </div>
                  </div>
                </div>
              </ng-container>
              <div *ngIf="!hasIndMag02" class="alert alert-warning">
                Indicator IND-MAG-02 not found.
              </div>
            </ng-container>

            <!-- Indicator IND-MAG-01 -->
            <ng-container *ngIf="indicators && indicators.length > 0">
              <ng-container *ngFor="let indicator of indicators">
                <div *ngIf="indicator.code === 'IND-MAG-01'" class="card mb-3 shadow-sm">
                  <div class="card-body">
                    <h5 class="card-title">{{ indicator.libelle || 'N/A' }} ({{ indicator.code }})</h5>
                    <div class="row justify-content-center">
                      <div class="col-md-6">
                        <div class="size-3">
                          <div
                            id="ind-mag-01-gauge"
                            class="gauge"
                            [appJustGage]="{
                              label: indicator.unite || 'Value',
                              value: indicator.currentValue !== null ? indicator.currentValue : 0,
                              min: 0,
                              max: indicator.cible !== null ? indicator.cible : 100,
                              decimals: 2,
                              gaugeWidthScale: 0.6,
                              pointer: true,
                              gaugeColor: ['rgba(42, 118, 244, .1)'],
                              levelColors: indicator.status === 'OK' ? ['#22c55e'] : ['#ff0000'],
                              pointerOptions: {
                                toplength: 10,
                                bottomlength: 10,
                                bottomwidth: 2,
                                color: '#ff5da0',
                                stroke: '#ffffff',
                                stroke_width: 3,
                                stroke_linecap: 'round'
                              },
                              counter: true
                            }"
                          ></div>
                        </div>
                      </div>
                    </div>
                    <div class="mt-3 text-center">
                      <strong>Status: </strong>
                      <span class="badge badge-lg" [ngClass]="{
                        'bg-success': indicator.status === 'OK',
                        'bg-danger': indicator.status === 'CRITICAL'
                      }">
                        {{ indicator.status || 'N/A' }}
                      </span>
                    </div>
                  </div>
                </div>
              </ng-container>
            </ng-container>

            <div *ngIf="indicators && indicators.length === 0" class="alert alert-info">
              No indicators available.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Non-Conformance Modal -->
  <ng-template #addNonConformanceModal let-modal>
    <div class="modal-header">
      <h6 class="modal-title m-0">Add Non-Conformance</h6>
      <button type="button" class="btn-close" (click)="modal.dismiss('Cross click')" aria-label="Close"></button>
    </div>
    <div class="modal-body">
      <form [formGroup]="nonConformanceForm" (ngSubmit)="addNonConformance()">
        <div class="mb-3">
          <label class="form-label fw-medium">Source:</label>
          <select id="source" class="form-control" formControlName="source">
            <option value="">Select a source</option>
            <option value="AUDIT">Audit</option>
            <option value="CONTROL_AND_MONITORING">CONTROL_AND_MONITORING</option>
            <option value="EXTERNAL_PROVIDERS">EXTERNAL_PROVIDERS</option>
            <option value="CLIENT_COMPLAINT">Customer Complaint</option>
            <option value="OTHERS">OTHERS</option>
          </select>
          <div *ngIf="submitted && nonConformanceForm.get('source')?.invalid" class="text-danger mt-1">
            Source is required.
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label fw-medium">Type:</label>
          <select id="type" class="form-control" formControlName="type">
            <option value="">Select a type</option>
            <option value="PERFORMANCE">Performance</option>
            <option value="OTHERS">Others</option>
            <option value="BUG">Bug</option>
            <option value="SECURITY">Security</option>
            <option value="COMPATIBILITY">Compatibility</option>
          </select>
          <div *ngIf="submitted && nonConformanceForm.get('type')?.invalid" class="text-danger mt-1">
            Type is required.
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label fw-medium">Description:</label>
          <textarea id="description" class="form-control" formControlName="description" rows="3"></textarea>
          <div *ngIf="submitted && nonConformanceForm.get('description')?.invalid" class="text-danger mt-1">
            Description is required.
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label fw-medium">Date Created:</label>
          <input type="date" id="dateCreated" class="form-control" formControlName="dateCreated" />
          <div *ngIf="submitted && nonConformanceForm.get('dateCreated')?.invalid" class="text-danger mt-1">
            Date Created is required.
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label fw-medium">Status:</label>
          <select id="status" class="form-control" formControlName="status">
            <option value="OPEN">Open</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label fw-medium">Indicator:</label>
          <select id="indicatorId" class="form-control" formControlName="indicatorId">
            <option [ngValue]="null">Select an indicator</option>
            <option *ngFor="let indicator of indicators" [ngValue]="indicator">
              {{ indicator.libelle }} ({{ indicator.code }})
            </option>
          </select>
          <div *ngIf="submitted && nonConformanceForm.get('indicatorId')?.invalid" class="text-danger mt-1">
            Indicator is required.
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save</button>
          <button type="button" class="btn btn-outline-danger btn-sm" (click)="modal.dismiss('Cancel click')">
            Close
          </button>
        </div>
      </form>
    </div>
  </ng-template>

  <!-- Fix Non-Conformity Modal -->
  <ng-template #fixNonConformityModal let-modal>
    <div class="modal-header">
      <h6 class="modal-title m-0">Fix Non-Conformity</h6>
      <button type="button" class="btn-close" (click)="modal.dismiss()" aria-label="Close"></button>
    </div>
    <div class="modal-body">
      <form [formGroup]="fixNonConformityForm">
        <div class="mb-3">
          <label class="form-label fw-medium">Action Taken</label>
          <textarea
            id="actionTaken"
            class="form-control"
            formControlName="actionTaken"
            rows="3"
            placeholder="Describe the action taken to fix the non-conformity"
          ></textarea>
          <div
            *ngIf="fixNonConformityForm.get('actionTaken')?.invalid && fixNonConformityForm.get('actionTaken')?.touched"
            class="text-danger mt-1"
          >
            Action taken is required
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label fw-medium">Fix Date</label>
          <input type="date" id="fixDate" class="form-control" formControlName="fixDate" />
          <div
            *ngIf="fixNonConformityForm.get('fixDate')?.invalid && fixNonConformityForm.get('fixDate')?.touched"
            class="text-danger mt-1"
          >
            Fix date is required
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label fw-medium">Is Effective?</label>
          <select id="isEffective" class="form-control" formControlName="isEffective">
            <option [ngValue]="true">Yes</option>
            <option [ngValue]="false">No</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label fw-medium">Supporting Documents</label>
          <input
            type="file"
            id="attachments"
            class="form-control"
            (change)="onFileSelected($event)"
            multiple
          />
          <small class="text-muted">Attach any relevant documents or evidence</small>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-outline-danger btn-sm" (click)="modal.dismiss()">Cancel</button>
      <button
        type="button"
        class="btn btn-primary"
        (click)="submitFixForm()"
        [disabled]="fixNonConformityForm.invalid"
      >
        Submit Fix
      </button>
    </div>
  </ng-template>

  <!-- Chatbot Modal -->
  <!-- Chatbot Toggler -->
  <button id="chatbot-toggler" (click)="toggleChatbotModal()" [ngClass]="{'show-chatbot': isChatbotOpen}">
    <svg class="chatbot-logo" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 1024 1024">
      <path
        d="M738.3 287.6H285.7c-59 0-106.8 47.8-106.8 106.8v303.1c0 59 47.8 106.8 106.8 106.8h81.5v111.1c0 .7.8 1.1 1.4.7l166.9-110.6 41.8-.8h117.4l43.6-.4c59 0 106.8-47.8 106.8-106.8V394.5c0-59-47.8-106.9-106.8-106.9zM351.7 448.2c0-29.5 23.9-53.5 53.5-53.5s53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5-53.5-23.9-53.5-53.5zm157.9 267.1c-67.8 0-123.8-47.5-132.3-109h264.6c-8.6 61.5-64.5 109-132.3 109zm110-213.7c-29.5 0-53.5-23.9-53.5-53.5s23.9-53.5 53.5-53.5 53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5zM867.2 644.5V453.1h26.5c19.4 0 35.1 15.7 35.1 35.1v121.1c0 19.4-15.7 35.1-35.1 35.1h-26.5zM95.2 609.4V488.2c0-19.4 15.7-35.1 35.1-35.1h26.5v191.3h-26.5c-19.4 0-35.1-15.7-35.1-35.1zM561.5 149.6c0 23.4-15.6 43.3-36.9 49.7v44.9h-30v-44.9c-21.4-6.5-36.9-26.3-36.9-49.7 0-28.6 23.3-51.9 51.9-51.9s51.9 23.3 51.9 51.9z"
        fill="#5350C4"
      />
    </svg>
    <span class="material-symbols-rounded">close</span>
  </button>

  <!-- Chatbot Modal -->
  <ng-template #chatbotModal let-modal>
    <div class="chatbot-popup">
      <!-- Chatbot Header -->
      <div class="chat-header">
        <div class="header-info">
          <svg class="chatbot-logo" xmlns="http://www.w3.org/2000/svg" width="35" height="35" viewBox="0 0 1024 1024">
            <path
              d="M738.3 287.6H285.7c-59 0-106.8 47.8-106.8 106.8v303.1c0 59 47.8 106.8 106.8 106.8h81.5v111.1c0 .7.8 1.1 1.4.7l166.9-110.6 41.8-.8h117.4l43.6-.4c59 0 106.8-47.8 106.8-106.8V394.5c0-59-47.8-106.9-106.8-106.9zM351.7 448.2c0-29.5 23.9-53.5 53.5-53.5s53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5-53.5-23.9-53.5-53.5zm157.9 267.1c-67.8 0-123.8-47.5-132.3-109h264.6c-8.6 61.5-64.5 109-132.3 109zm110-213.7c-29.5 0-53.5-23.9-53.5-53.5s23.9-53.5 53.5-53.5 53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5zM867.2 644.5V453.1h26.5c19.4 0 35.1 15.7 35.1 35.1v121.1c0 19.4-15.7 35.1-35.1 35.1h-26.5zM95.2 609.4V488.2c0-19.4 15.7-35.1 35.1-35.1h26.5v191.3h-26.5c-19.4 0-35.1-15.7-35.1-35.1zM561.5 149.6c0 23.4-15.6 43.3-36.9 49.7v44.9h-30v-44.9c-21.4-6.5-36.9-26.3-36.9-49.7 0-28.6 23.3-51.9 51.9-51.9s51.9 23.3 51.9 51.9z"
              fill="#5350C4"
            />
          </svg>
          <h2 class="logo-text">Quality Management AI Assistant</h2>
        </div>
        <button id="close-chatbot" (click)="modal.dismiss('Close click')">
          <i class="fas fa-window-close"></i>
        </button>
      </div>
      <!-- Chatbot Body -->
      <div class="chat-body" #chatBody>
        <!-- Initial Bot Message -->
        <div class="message bot-message">
          <svg class="bot-avatar" xmlns="http://www.w3.org/2000/svg" width="35" height="35" viewBox="0 0 1024 1024">
            <path
              d="M738.3 287.6H285.7c-59 0-106.8 47.8-106.8 106.8v303.1c0 59 47.8 106.8 106.8 106.8h81.5v111.1c0 .7.8 1.1 1.4.7l166.9-110.6 41.8-.8h117.4l43.6-.4c59 0 106.8-47.8 106.8-106.8V394.5c0-59-47.8-106.9-106.8-106.9zM351.7 448.2c0-29.5 23.9-53.5 53.5-53.5s53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5-53.5-23.9-53.5-53.5zm157.9 267.1c-67.8 0-123.8-47.5-132.3-109h264.6c-8.6 61.5-64.5 109-132.3 109zm110-213.7c-29.5 0-53.5-23.9-53.5-53.5s23.9-53.5 53.5-53.5 53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5zM867.2 644.5V453.1h26.5c19.4 0 35.1 15.7 35.1 35.1v121.1c0 19.4-15.7 35.1-35.1 35.1h-26.5zM95.2 609.4V488.2c0-19.4 15.7-35.1 35.1-35.1h26.5v191.3h-26.5c-19.4 0-35.1-15.7-35.1-35.1zM561.5 149.6c0 23.4-15.6 43.3-36.9 49.7v44.9h-30v-44.9c-21.4-6.5-36.9-26.3-36.9-49.7 0-28.6 23.3-51.9 51.9-51.9s51.9 23.3 51.9 51.9z"
              fill="#fff"
            />
          </svg>
          <div class="message-text">Hey there! How can I help you with non-conformities today?</div>
        </div>
        <!-- Conversation Messages -->
        <div *ngFor="let msg of conversation" class="message" [ngClass]="msg.sender === 'user' ? 'user-message' : 'bot-message'">
          <div *ngIf="msg.sender === 'user'" class="message-text">
            <strong>You:</strong> {{ msg.text }}
          </div>
          <div *ngIf="msg.sender === 'ai' && !msg.error" class="message-text">
            <svg class="bot-avatar" xmlns="http://www.w3.org/2000/svg" width="35" height="35" viewBox="0 0 1024 1024">
              <path
                d="M738.3 287.6H285.7c-59 0-106.8 47.8-106.8 106.8v303.1c0 59 47.8 106.8 106.8 106.8h81.5v111.1c0 .7.8 1.1 1.4.7l166.9-110.6 41.8-.8h117.4l43.6-.4c59 0 106.8-47.8 106.8-106.8V394.5c0-59-47.8-106.9-106.8-106.9zM351.7 448.2c0-29.5 23.9-53.5 53.5-53.5s53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5-53.5-23.9-53.5-53.5zm157.9 267.1c-67.8 0-123.8-47.5-132.3-109h264.6c-8.6 61.5-64.5 109-132.3 109zm110-213.7c-29.5 0-53.5-23.9-53.5-53.5s23.9-53.5 53.5-53.5 53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5zM867.2 644.5V453.1h26.5c19.4 0 35.1 15.7 35.1 35.1v121.1c0 19.4-15.7 35.1-35.1 35.1h-26.5zM95.2 609.4V488.2c0-19.4 15.7-35.1 35.1-35.1h26.5v191.3h-26.5c-19.4 0-35.1-15.7-35.1-35.1zM561.5 149.6c0 23.4-15.6 43.3-36.9 49.7v44.9h-30v-44.9c-21.4-6.5-36.9-26.3-36.9-49.7 0-28.6 23.3-51.9 51.9-51.9s51.9 23.3 51.9 51.9z"
                fill="#fff"
              />
            </svg>
            <strong>AI:</strong>
            <!-- Structured Response -->
            <span *ngIf="msg.response">
              For the non-conformity with
              <ng-container *ngIf="msg.response.source">Source: {{ msg.response.source }}</ng-container>
              <ng-container *ngIf="msg.response.type && msg.response.source">, </ng-container>
              <ng-container *ngIf="msg.response.type">Type: {{ msg.response.type }}</ng-container>
              <ng-container *ngIf="(msg.response.source || msg.response.type) && msg.response.iso_clause">, it relates to </ng-container>
              <ng-container *ngIf="msg.response.iso_clause">ISO 9001 Clause: {{ msg.response.iso_clause }}</ng-container>
              <ng-container *ngIf="(msg.response.source || msg.response.type || msg.response.iso_clause) && msg.response.solution">.</ng-container>
              <ng-container *ngIf="msg.response.solution"> The proposed solution is {{ msg.response.solution }}</ng-container>
              <ng-container *ngIf="(msg.response.source || msg.response.type || msg.response.iso_clause || msg.response.solution) && msg.response.message">.</ng-container>
              <ng-container *ngIf="msg.response.message"> {{ msg.response.message }}</ng-container>
              <ng-container *ngIf="!(msg.response.source || msg.response.type || msg.response.iso_clause || msg.response.solution || msg.response.message)">No details provided.</ng-container>
            </span>
            <!-- Freeform Response -->
            <span *ngIf="msg.freeformResponse">
              {{ msg.freeformResponse }}
            </span>
          </div>
          <div *ngIf="msg.sender === 'ai' && msg.error" class="message-text error">
            <svg class="bot-avatar" xmlns="http://www.w3.org/2000/svg" width="35" height="35" viewBox="0 0 1024 1024">
              <path
                d="M738.3 287.6H285.7c-59 0-106.8 47.8-106.8 106.8v303.1c0 59 47.8 106.8 106.8 106.8h81.5v111.1c0 .7.8 1.1 1.4.7l166.9-110.6 41.8-.8h117.4l43.6-.4c59 0 106.8-47.8 106.8-106.8V394.5c0-59-47.8-106.9-106.8-106.9zM351.7 448.2c0-29.5 23.9-53.5 53.5-53.5s53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5-53.5-23.9-53.5-53.5zm157.9 267.1c-67.8 0-123.8-47.5-132.3-109h264.6c-8.6 61.5-64.5 109-132.3 109zm110-213.7c-29.5 0-53.5-23.9-53.5-53.5s23.9-53.5 53.5-53.5 53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5zM867.2 644.5V453.1h26.5c19.4 0 35.1 15.7 35.1 35.1v121.1c0 19.4-15.7 35.1-35.1 35.1h-26.5zM95.2 609.4V488.2c0-19.4 15.7-35.1 35.1-35.1h26.5v191.3h-26.5c-19.4 0-35.1-15.7-35.1-35.1zM561.5 149.6c0 23.4-15.6 43.3-36.9 49.7v44.9h-30v-44.9c-21.4-6.5-36.9-26.3-36.9-49.7 0-28.6 23.3-51.9 51.9-51.9s51.9 23.3 51.9 51.9z"
                fill="#fff"
              />
            </svg>
            <strong>AI:</strong> {{ msg.error }}
          </div>
        </div>
        <!-- Loading State -->
        <div *ngIf="loading" class="message bot-message thinking">
          <svg class="bot-avatar" xmlns="http://www.w3.org/2000/svg" width="35" height="35" viewBox="0 0 1024 1024">
            <path
              d="M738.3 287.6H285.7c-59 0-106.8 47.8-106.8 106.8v303.1c0 59 47.8 106.8 106.8 106.8h81.5v111.1c0 .7.8 1.1 1.4.7l166.9-110.6 41.8-.8h117.4l43.6-.4c59 0 106.8-47.8 106.8-106.8V394.5c0-59-47.8-106.9-106.8-106.9zM351.7 448.2c0-29.5 23.9-53.5 53.5-53.5s53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5-53.5-23.9-53.5-53.5zm157.9 267.1c-67.8 0-123.8-47.5-132.3-109h264.6c-8.6 61.5-64.5 109-132.3 109zm110-213.7c-29.5 0-53.5-23.9-53.5-53.5s23.9-53.5 53.5-53.5 53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5zM867.2 644.5V453.1h26.5c19.4 0 35.1 15.7 35.1 35.1v121.1c0 19.4-15.7 35.1-35.1 35.1h-26.5zM95.2 609.4V488.2c0-19.4 15.7-35.1 35.1-35.1h26.5v191.3h-26.5c-19.4 0-35.1-15.7-35.1-35.1zM561.5 149.6c0 23.4-15.6 43.3-36.9 49.7v44.9h-30v-44.9c-21.4-6.5-36.9-26.3-36.9-49.7 0-28.6 23.3-51.9 51.9-51.9s51.9 23.3 51.9 51.9z"
              fill="#fff"
            />
          </svg>
          <div class="message-text">
            <div class="thinking-indicator">
              <span class="dot"></span>
              <span class="dot"></span>
              <span class="dot"></span>
            </div>
          </div>
        </div>
      </div>
      <!-- Chatbot Footer -->
      <div class="chat-footer">
        <form class="chat-form" (ngSubmit)="sendQuery()">
        <textarea
          placeholder="Enter query (e.g., Source: Production, Type: Defect)"
          class="message-input"
          [(ngModel)]="query"
          [ngModelOptions]="{standalone: true}"
          [disabled]="loading"
        ></textarea>
          <div class="chat-controls">
            <button type="submit" id="send-message" [disabled]="loading || !query.trim()">
              <i class="fa-solid fa-paper-plane"></i>
            </button>
            <button type="button" id="clear-message" class="material-symbols-rounded" (click)="clear()" [disabled]="loading"><i class="fas fa-trash-alt"></i></button>
          </div>
        </form>
      </div>
    </div>
  </ng-template>
</div>

<!-- Details View -->
<div class="container my-5" *ngIf="selectedNonConformity">
  <div class="card shadow-sm border-0">
    <div class="card-body p-4">
      <!-- Header -->
      <div class="section-header d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
        <h4 class="mb-0 fs-5 text-dark">
          <i class="las la-info-circle me-2 fs-5 text-primary"></i>Non-Conformity Details
        </h4>
        <div class="button-container">
          <button class="btn btn-primary " (click)="navigateToIsoClauses()">
            <i class="las la-book me-2"></i>Check ISO Clauses
          </button>
          <button class="btn btn-outline-secondary" (click)="backToList()">
              <i class="las la-arrow-left me-2"></i>Back to List
          </button>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="loading" class="text-center text-muted mb-4">
        <i class="las la-spinner la-spin me-2"></i>Loading...
      </div>

      <!-- Content -->
      <div class="row" *ngIf="!loading">
        <div class="col-md-8">
          <!-- Basic Information -->
          <div class="section-item border-0 mb-4 shadow-sm p-4 rounded bg-white">
            <h5 class="fw-bold text-secondary mb-4">Basic Information</h5>
            <div class="table-responsive">
              <table class="table datatable table-bordered">
                <tbody>
                <tr>
                  <th width="200">Source</th>
                  <td>{{ selectedNonConformity.source }}</td>
                </tr>
                <tr>
                  <th>Type</th>
                  <td>{{ selectedNonConformity.type }}</td>
                </tr>
                <tr>
                  <th>Description</th>
                  <td>{{ selectedNonConformity.description }}</td>
                </tr>
                <tr>
                  <th>Creation Date</th>
                  <td>{{ selectedNonConformity.dateCreated | date:'medium' }}</td>
                </tr>
                <tr>
                  <th>Detected By</th>
                  <td>{{ selectedNonConformity.detectedBy || 'N/A' }}</td>
                </tr>
                <tr>
                  <th>Date Detected</th>
                  <td>{{ selectedNonConformity.dateDetected | date:'medium' }}</td>
                </tr>
                <tr>
                  <th>Status</th>
                  <td>
                      <span class="badge badge-lg" [ngClass]="{
                        'bg-warning text-dark': selectedNonConformity.status === 'OPEN',

                        'bg-success': selectedNonConformity.status === 'FIXED'
                      }">
                        {{ selectedNonConformity.status }}
                      </span>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Indicator Information -->
          <div class="section-item border-0 mb-4 shadow-sm p-4 rounded bg-white">
            <h5 class="fw-bold text-secondary mb-4">Indicator Information</h5>
            <div class="table-responsive">
              <table class="table datatable table-bordered">
                <tbody>
                <tr>
                  <th width="200">Indicator Code</th>
                  <td>{{ selectedNonConformity.indicator?.code || 'N/A' }}</td>
                </tr>
                <tr>
                  <th>Indicator Frequence</th>
                  <td>{{ selectedNonConformity.indicator?.frequence || 'N/A' }}</td>
                </tr>
                <tr>
                  <th>Indicator Name</th>
                  <td>{{ selectedNonConformity.indicator?.libelle || 'N/A' }}</td>
                </tr>
                <tr>
                  <th>Indicator Unit</th>
                  <td>{{ selectedNonConformity.indicator?.unite || 'N/A' }}</td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Fix Information -->
          <div class="section-item border-0 mb-4 shadow-sm p-4 rounded bg-white" *ngIf="selectedNonConformity.fixDate || selectedNonConformity.fixedBy || selectedNonConformity.actionTaken">
            <h5 class="fw-bold text-secondary mb-4">Fix Information</h5>
            <div class="table-responsive">
              <table class="table datatable table-bordered">
                <tbody>
                <tr>
                  <th width="200">Fixed By</th>
                  <td>{{ selectedNonConformity.fixedBy || 'Not fixed yet' }}</td>
                </tr>
                <tr>
                  <th>Fix Date</th>
                  <td>{{ selectedNonConformity.fixDate ? (selectedNonConformity.fixDate | date:'medium') : 'Not fixed yet' }}</td>
                </tr>
                <tr>
                  <th>Action Taken</th>
                  <td>{{ selectedNonConformity.actionTaken || 'No action recorded' }}</td>
                </tr>
                <tr>
                  <th>Is Effective</th>
                  <td>{{ selectedNonConformity.isEffective !== null ? (selectedNonConformity.isEffective ? 'Yes' : 'No') : 'Not evaluated' }}</td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Attachments -->
          <div class="section-item border-0 mb-4 shadow-sm p-4 rounded bg-white" *ngIf="selectedNonConformity.attachments?.length">
            <h5 class="fw-bold text-secondary mb-4">Attachments</h5>
            <div class="list-group">
              <a *ngFor="let attachment of selectedNonConformity.attachments"
                 [href]="attachment"
                 target="_blank"
                 class="list-group-item list-group-item-action">
                <i class="las la-paperclip me-2"></i>{{ attachment.split('/').pop() }}
              </a>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <!-- Status Card -->
          <div class="card mb-3 shadow-sm">
            <div class="card-body">
              <h5 class="card-title">Current Status</h5>
              <div class="alert" [ngClass]="{
                'alert-danger': selectedNonConformity.status === 'OPEN',
                'alert-warning': selectedNonConformity.status === 'IN_PROGRESS',
                'alert-success': selectedNonConformity.status === 'FIXED'
              }">
                <h5 class="alert-heading">
                  <i class="las la-exclamation-circle me-2"></i>{{ selectedNonConformity.status }}
                </h5>
                <p class="mb-0" *ngIf="selectedNonConformity.status === 'OPEN'">
                  This non-conformity requires immediate attention.
                </p>
                <p class="mb-0" *ngIf="selectedNonConformity.status === 'IN_PROGRESS'">
                  This non-conformity is being addressed.
                </p>
                <p class="mb-0" *ngIf="selectedNonConformity.status === 'FIXED'">
                  This non-conformity has been resolved.
                </p>
              </div>
              <div class="d-grid gap-2">
                <button class="btn btn-outline-danger"
                        (click)="openFixModal(selectedNonConformity, fixNonConformityModal)"
                        *ngIf="selectedNonConformity && selectedNonConformity.status !== 'FIXED'">
                  <i class="las la-tools me-2"></i>Fix Non-Conformity
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
