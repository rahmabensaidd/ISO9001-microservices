<div class="topbar d-print-none">
  <div class="container-xxl">
    <nav
      class="topbar-custom d-flex justify-content-between"
      [class.nav-sticky]="scrollY > 50"
      id="topbar-custom"
    >
      <ul class="topbar-item list-unstyled d-inline-flex align-items-center mb-0">
        <li *ngIf="shouldShowItem('mobile-menu')">
          <button
            (click)="toggleMobileMenu()"
            class="nav-link mobile-menu-btn nav-icon"
            id="togglemenu"
            data-key="mobile-menu"
          >
            <i class="iconoir-menu-scale"></i>
          </button>
        </li>
        <li *ngIf="shouldShowItem('welcome-text')" class="mx-3 welcome-text" data-key="welcome-text">
          <h3 class="mb-0 fw-bold text-truncate">Hello {{ userName }}</h3>
        </li>
      </ul>
      <ul class="topbar-item list-unstyled d-inline-flex align-items-center mb-0">
        <li *ngIf="shouldShowItem('app-search')" class="hide-phone app-search" ngbDropdown #searchDropdown="ngbDropdown" data-key="app-search">
          <form role="search" action="#" method="get">
            <div ngbDropdown class="d-inline-block">
              <input
                type="search"
                name="search"
                class="form-control top-search mb-0"
                placeholder="Search users, processes, tasks..."
                (input)="onSearch($event, searchDropdown)"
                ngbDropdownToggle
              />
              <button type="button"><i class="iconoir-search"></i></button>
            </div>
          </form>
          <div
            class="dropdown-menu dropdown-menu-end dropdown-lg py-0"
            ngbDropdownMenu
            *ngIf="searchResults.length > 0"
          >
            <h5 class="dropdown-item-text m-0 py-3 d-flex justify-content-between align-items-center">
              Search Results ({{ searchResults.length }})
              <a href="javascript:void(0);" class="badge text-body-tertiary badge-pill" (click)="clearSearch()">
                <i class="iconoir-xmark-circle fs-4"></i>
              </a>
            </h5>
            <ngx-simplebar class="ms-0" style="max-height: 230px">
              <div class="tab-content">
                <div class="tab-pane fade show active" role="tabpanel">
                  <a
                    *ngFor="let result of searchResults"
                    href="javascript:void(0);"
                    class="dropdown-item py-3"
                    (click)="navigateToDetails(result)"
                    [ngClass]="{'bg-light': result.entityType === 'User'}"
                  >
                    <div class="d-flex align-items-center">
                      <div class="flex-shrink-0 bg-primary-subtle text-primary thumb-md rounded-circle">
                        <i
                          [class]="result.entityType === 'Process' ? 'iconoir-folder' :
                                  result.entityType === 'Operation' ? 'iconoir-tools' :
                                  result.entityType === 'Task' ? 'iconoir-task-list' :
                                  'iconoir-user'"
                          class="fs-4"
                        ></i>
                      </div>
                      <div class="flex-grow-1 ms-2 text-truncate">
                        <h6 class="my-0 fw-normal text-dark fs-13">
                          {{ result.entityType }}: {{ result.displayName }}
                          <span *ngIf="result.entityType === 'User' && result.assignedUsers && result.assignedUsers.length > 0">
                            ({{ result.assignedUsers[0] }})
                          </span>
                        </h6>
                        <small class="text-muted mb-0">{{ result.description }}</small>
                      </div>
                    </div>
                  </a>
                  <div *ngIf="searchResults.length === 0" class="dropdown-item py-3 text-center">
                    No results found
                  </div>
                </div>
              </div>
            </ngx-simplebar>
          </div>
        </li>

        <li *ngIf="shouldShowItem('light-dark-mode')" class="topbar-item" data-key="light-dark-mode">
          <a
            class="nav-link nav-icon"
            (click)="changeTheme()"
            href="javascript:void(0);"
            id="light-dark-mode"
          >
            <i class="icofont-sun dark-mode"></i>
            <i class="icofont-moon light-mode"></i>
          </a>
        </li>
        <li *ngIf="shouldShowItem('pages') && pagesMenu" class="dropdown topbar-item" ngbDropdown data-key="pages">
          <a
            class="nav-link dropdown-toggle arrow-none nav-icon"
            ngbDropdownToggle
            data-bs-toggle="dropdown"
            href="javascript:void(0);"
            role="button"
            aria-haspopup="false"
            aria-expanded="false"
          >
            <i class="{{ pagesMenu.icon }}"></i>
            <span>{{ pagesMenu.label }}</span>
          </a>
          <div class="dropdown-menu dropdown-menu-end py-0" ngbDropdownMenu>
            <a *ngFor="let subMenu of pagesMenu.subMenu" class="dropdown-item" [routerLink]="subMenu.url">
              {{ subMenu.label }}
            </a>
          </div>
        </li>
        <li *ngIf="shouldShowItem('notifications')" class="dropdown topbar-item" ngbDropdown data-key="notifications">
          <a class="nav-link dropdown-toggle arrow-none nav-icon"
             ngbDropdownToggle
             data-bs-toggle="dropdown"
             href="javascript:void(0);"
             role="button"
             aria-haspopup="false"
             aria-expanded="false">
            <i class="icofont-bell-alt"></i>
            <span class="alert-badge" *ngIf="nonConformities.length + processNotifications.length + auditNotifications.length > 0">
              {{ nonConformities.length + processNotifications.length + auditNotifications.length }}
            </span>
          </a>
          <div class="dropdown-menu stop dropdown-menu-end dropdown-lg py-0" ngbDropdownMenu>
            <h5 class="dropdown-item-text m-0 py-3 d-flex justify-content-between align-items-center">
              Alerts
              <span class="badge bg-danger">{{ nonConformities.length + processNotifications.length + auditNotifications.length }}</span>
            </h5>
            <ngx-simplebar class="ms-0" style="max-height: 230px">
              <div class="tab-content">
                <div class="tab-pane fade show active" role="tabpanel">
                  <!-- Non-Conformity Notifications -->
                  @for (item of nonConformities; track $index) {
                    <a (click)="navigateToNonConformitydetails(item.idNonConformity!)" class="dropdown-item py-3 cursor-pointer">
                      <small class="float-end text-muted ps-2">{{ item.dateCreated | date:'short' }}</small>
                      <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 bg-danger-subtle text-danger thumb-md rounded-circle">
                          <i class="iconoir-warning-circle fs-4"></i>
                        </div>
                        <div class="flex-grow-1 ms-2 text-truncate">
                          <h6 class="my-0 fw-normal text-dark fs-13">{{ item.source }}</h6>
                          <small class="text-muted mb-0">{{ item.description }}</small>
                        </div>
                      </div>
                    </a>
                  }
                  <!-- Process Notifications -->
                  @for (item of processNotifications; track $index) {
                    <a (click)="navigateToProcessDetails(item.id)" class="dropdown-item py-3 cursor-pointer">
                      <small class="float-end text-muted ps-2">{{ item.timestamp | date:'short' }}</small>
                      <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 bg-primary-subtle text-primary thumb-md rounded-circle">
                          <i class="iconoir-folder fs-4"></i>
                        </div>
                        <div class="flex-grow-1 ms-2 text-truncate">
                          <h6 class="my-0 fw-normal text-dark fs-13">Process Alert</h6>
                          <small class="text-muted mb-0">{{ item.message }}</small>
                        </div>
                      </div>
                    </a>
                  }
                  <!-- Audit Notifications -->
                  @for (item of auditNotifications; track $index) {
                    <a (click)="navigateToAuditDetails(item.id)" class="dropdown-item py-3 cursor-pointer">
                      <small class="float-end text-muted ps-2">{{ item.timestamp | date:'short' }}</small>
                      <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 bg-warning-subtle text-warning thumb-md rounded-circle">
                          <i class="icofont-shield fs-4"></i>
                        </div>
                        <div class="flex-grow-1 ms-2 text-truncate">
                          <h6 class="my-0 fw-bold text-dark fs-13">Audit Alert</h6>
                          <small class="text-muted mb-0">{{ item.message }}</small>
                        </div>
                      </div>
                    </a>
                  }
                  @if (nonConformities.length === 0 && processNotifications.length === 0 && auditNotifications.length === 0) {
                    <div class="dropdown-item py-3 text-center">
                      No alerts found
                    </div>
                  }
                </div>
              </div>
            </ngx-simplebar>
            <a (click)="viewAllNonConformities()" class="dropdown-item text-center text-dark fs-13 py-2 cursor-pointer">
              View All Non-Conformities <i class="fi-arrow-right"></i>
            </a>
            <a (click)="clearNotifications()" class="dropdown-item text-center text-dark fs-13 py-2 cursor-pointer">
              Clear Notifications <i class="fi-trash"></i>
            </a>
          </div>
        </li>
        <li *ngIf="shouldShowItem('profile')" class="dropdown topbar-item" ngbDropdown placement="bottom-end" data-key="profile">
          <a
            class="nav-link dropdown-toggle arrow-none nav-icon"
            ngbDropdownToggle
            data-bs-toggle="dropdown"
            href="javascript:void(0);"
            role="button"
            aria-haspopup="false"
            aria-expanded="false"
          >
            <img [src]="profilePhotoUrl" alt="Profile Photo" class="thumb-lg rounded-circle" />
          </a>
          <div class="dropdown-menu dropdown-menu-end py-0" ngbDropdownMenu>
            <div class="d-flex align-items-center dropdown-item py-2 bg-secondary-subtle">
              <div class="flex-shrink-0">
                <img [src]="profilePhotoUrl" alt="Profile Photo" class="thumb-md rounded-circle" />
              </div>
              <div class="flex-grow-1 ms-2 text-truncate align-self-center">
                <h6 class="my-0 fw-medium text-dark fs-13">{{ userName }}</h6>
                <small class="text-muted mb-0">{{ userEmail }}</small>
              </div>
            </div>
            <div class="dropdown-divider mt-0"></div>
            <small class="text-muted px-2 pb-1 d-block">Account</small>
            <a class="dropdown-item" [routerLink]="['/profile', userId]">
              <i class="las la-user fs-18 me-1 align-text-bottom"></i> Profile
            </a>
            <a *ngIf="isAdmin" class="dropdown-item" routerLink="/apps/ecommerce/orders">
              <i class="la-wallet fs-18 me-1 align-text-bottom"></i> Earning
            </a>
            <small class="text-muted px-2 py-1 d-block">Settings</small>
            <a class="dropdown-item" [routerLink]="['/profile', userId]">
              <i class="las la-cog fs-18 me-1 align-text-bottom"></i> Account Settings
            </a>
            <a class="dropdown-item" routerLink="/auth/lock-screen" target="_blank">
              <i class="las la-lock fs-18 me-1 align-text-bottom"></i> Lock
            </a>
            <a class="dropdown-item" routerLink="/pages/faqs">
              <i class="las la-question-circle fs-18 me-1 align-text-bottom"></i> Help Center
            </a>
            <div class="dropdown-divider mb-0"></div>
            <a class="dropdown-item text-danger" (click)="logout()">
              <i class="las la-power-off fs-18 me-1 align-text-bottom"></i> Logout
            </a>
          </div>
        </li>
      </ul>
    </nav>
  </div>
</div>
