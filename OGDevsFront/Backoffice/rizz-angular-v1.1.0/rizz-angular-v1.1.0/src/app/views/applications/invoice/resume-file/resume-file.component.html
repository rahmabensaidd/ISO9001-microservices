<div class="container mt-5">
  <!-- Card pour l'upload -->
  <div class="card shadow-lg">
    <div class="card-header bg-primary text-white">
      <h4 class="card-title mb-0">Managing Summaries with OCR</h4>
    </div>
    <div class="card-body">
      <!-- Instructions sur la taille maximale -->
      <div class="alert alert-info" role="alert">
        <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
        Maximum file size: 25 MB. Accepted formats: PDF, PNG, JPEG, DOC, DOCX, TXT
      </div>

      <!-- Zone de téléversement -->
      <div class="upload-area"
           (dragover)="onDragOver($event)"
           (dragleave)="onDragLeave($event)"
           (drop)="onDrop($event)">
        <div class="drop-zone text-center p-5" [class.dragover]="isDragging">
          <i class="fas fa-cloud-upload-alt fa-3x text-primary" aria-hidden="true"></i>
          <h5 class="mt-3">Drag and drop your files here</h5>
          <p class="text-muted">or</p>
          <input type="file" #fileInput (change)="onFileSelected($event)" accept=".pdf,.png,.jpg,.jpeg,.doc,.docx,.txt" hidden>
          <button class="btn btn-primary" (click)="fileInput.click()" aria-label="Browse files">Browse</button>
        </div>
      </div>

      <!-- Barre de progression -->
      <div class="progress mt-3" *ngIf="isProcessing && uploadProgress > 0">
        <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
             [style.width.%]="uploadProgress"
             role="progressbar"
             [attr.aria-valuenow]="uploadProgress"
             aria-valuemin="0"
             aria-valuemax="100">
          {{ uploadProgress }}%
        </div>
      </div>

      <!-- Afficher le nom et la taille du fichier sélectionné -->
      <div class="mt-3" *ngIf="selectedFile">
        <p class="text-muted">
          Selected file: {{ selectedFile.name }}
          ({{ (selectedFile.size / (1024 * 1024)).toFixed(2) }} MB)
        </p>
      </div>

      <!-- Afficher les erreurs -->
      <div class="alert alert-danger mt-3" *ngIf="errorMessage" role="alert">
        {{ errorMessage }}
      </div>
    </div>
  </div>

  <!-- Tabs pour Files et Archive -->
  <ul class="nav nav-tabs mt-4">
    <li class="nav-item">
      <a class="nav-link" [class.active]="currentTab === 'Files'" (click)="switchTab('Files')">Files</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="currentTab === 'Archive'" (click)="switchTab('Archive')">Archive</a>
    </li>
  </ul>

  <!-- Recherche -->
  <div class="input-group mt-3">
    <form role="search" (submit)="searchDocuments()">
      <div class="input-group">
        <input
          type="search"
          name="search"
          class="form-control top-search mb-0"
          placeholder="Search here..."
          [(ngModel)]="searchKeyword"
          (input)="searchDocuments()"
        />
        <button type="submit" class="btn btn-primary" (click)="searchDocuments()" aria-label="Search documents">
          <i class="iconoir-search" aria-hidden="true"></i>
        </button>
      </div>
    </form>
  </div>

  <!-- Table view for both Files and Archive -->
  <div class="table-responsive mt-3">
    <table class="table table-striped">
      <thead>
      <tr>
        <th scope="col">Title</th>
        <th scope="col">Creation date</th>
        <th scope="col">Category</th>
        <th scope="col">Actions</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let doc of documents$ | async">
        <td>{{ doc.title }}</td>
        <td>{{ doc.dateCreation | date:'dd/MM/yyyy' }}</td>
        <td>{{ doc.category }}</td>
        <td>
          <button class="btn btn-info btn-sm me-2" (click)="viewSummary(doc)" aria-label="View summary">See</button>
          <button class="btn btn-secondary btn-sm me-2" (click)="selectDocument(doc)" aria-label="View document versions">Versions</button>
          <button class="btn btn-warning btn-sm me-2" (click)="archiveDocument(doc.id)" *ngIf="currentTab === 'Files'" aria-label="Archive document">Archive</button>
          <button class="btn btn-success btn-sm me-2" (click)="unarchiveDocument(doc.id)" *ngIf="currentTab === 'Archive'" aria-label="Unarchive document">Unarchive</button>
          <button class="btn btn-danger btn-sm" (click)="deleteDocument(doc.id)" aria-label="Delete document">Delete</button>
        </td>
      </tr>
      <tr *ngIf="(documents$ | async)?.length === 0">
        <td colspan="4" class="text-center">No documents found.</td>
      </tr>
      </tbody>
    </table>
  </div>

  <!-- Popup pour la configuration -->
  <div class="modal fade" [class.show]="showConfigPopup" [style.display]="showConfigPopup ? 'block' : 'none'" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Configure Summary</h5>
          <button type="button" class="btn-close btn-close-white" (click)="closeConfigPopup()" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form [formGroup]="configForm">
            <div class="mb-3">
              <label class="form-label fw-bold" for="summaryLength">Summary length (characters):</label>
              <input type="number" class="form-control" formControlName="summaryLength" id="summaryLength">
              <div *ngIf="configForm.get('summaryLength')?.invalid && configForm.get('summaryLength')?.touched" class="text-danger">
                The length must be between 50 and 1000 characters.
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold">Remove blank pages:</label>
              <div class="form-check">
                <input type="checkbox" class="form-check-input" formControlName="removeBlankPages" id="removeBlankPages">
                <label class="form-check-label" for="removeBlankPages">Yes</label>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold" for="colorMode">Color mode:</label>
              <select class="form-control" formControlName="colorMode" id="colorMode">
                <option value="color">Color</option>
                <option value="grayscale">Grayscale</option>
                <option value="black_white">Black and white</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeConfigPopup()">Cancel</button>
          <button type="button" class="btn btn-primary" (click)="startProcessing()" [disabled]="configForm.invalid">Commit to Processing</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade" [class.show]="showConfigPopup" [style.display]="showConfigPopup ? 'block' : 'none'"></div>

  <!-- Popup pour le résumé -->
  <div class="modal fade" [class.show]="showPopup" [style.display]="showPopup ? 'block' : 'none'" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Document Summary</h5>
          <button type="button" class="btn-close btn-close-white" (click)="closePopup()" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div *ngIf="isProcessing" class="text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p>Processing in progress...</p>
          </div>
          <div *ngIf="!isProcessing && (selectedDocument || summary)">
            <div class="preview-card" #printableContent>
              <div class="header">
                <img src="assets/images/cropped-coconsultlogo_flood2__3_.png" alt="Logo" class="logo">
                <div class="header-info">
                  <h5>Document: #{{ selectedDocument?.id || 'BBN2351D458' }}</h5>
                  <h5>Date: {{ (selectedDocument?.dateCreation || currentDate) | date:'dd/MM/yyyy' }}</h5>
                  <h5>Created by: {{ currentUser }}</h5>
                </div>
              </div>
              <div class="content">
                <h6>Summary:</h6>
                <p>{{ selectedDocument?.summary || summary }}</p>
                <h6>Full content:</h6>
                <p>{{ selectedDocument?.content || 'Content not available' }}</p>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closePopup()">Close</button>
          <button type="button" class="btn btn-primary" (click)="downloadFullDocument()" [disabled]="isProcessing">Download PDF</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade" [class.show]="showPopup" [style.display]="showPopup ? 'block' : 'none'"></div>
</div>
<style>
  .container.mt-5,
  .container.mt-5 .card,
  .container.mt-5 .modal-content {
    background-color: white;
  }
</style>
